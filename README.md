# MEPHIT

## Installation

Prerequisites from external sources for running MEPHIT are as follows.

- current GNU/Linux environment (Bash, coreutils, getopt, ...)
- current Fortran compiler (tested with `gfortran` >= 13.1.0)
- [Doxygen](https://doxygen.nl/) and [TeX Live](https://www.tug.org/texlive/) for documentation
- [CMake](https://cmake.org/)
- [LAPACK](https://www.netlib.org/lapack/)
- [SuiteSparse](https://github.com/DrTimothyAldenDavis/SuiteSparse)
- [SuperLU](https://github.com/xiaoyeli/superlu)
- [GSL](https://www.gnu.org/software/gsl/) and [FGSL](https://github.com/reinh-bader/fgsl)
- [FFTW3](http://fftw.org/)
- [Triangle](https://www.cs.cmu.edu/~quake/triangle.html)
- [Boost](https://www.boost.org/)
- [FreeFem++](https://github.com/FreeFem/FreeFem-sources)
- [HDF5](https://www.hdfgroup.org/downloads/hdf5)
- [NetCDF](https://github.com/Unidata/netcdf-fortran)
- Python 3 including packages listed in [`requirements.txt`](requirements.txt)
- [jupytext](https://github.com/mwouts/jupytext) to use plotting scripts as Jupyter Notebooks

### Initial build

In the following sections, it is assumed that the environment variable `MEPHIT_DIR` points to the desired build directory. If libneo & KiLCA, MFEM & FGSL are not in their default location (adjacent to MEPHIT and in the system default, respectively), the environment variables `LIBNEO_DIR`, `KILCA_DIR`, `MFEM_DIR`, and `FGSL_PATH` need to be set as well. At ITPcp, you can put the following into your `~/.bashrc`:

```bash
export LIBNEO_DIR=/temp/AG-plasma/codes/libneo/build-master
export KILCA_DIR=/temp/AG-plasma/codes/KiLCA-2.4.2/lib
export FGSL_PATH=/temp/AG-plasma/codes/contrib/fgsl-1.5.0/LIB
export MFEM_DIR=/temp/AG-plasma/codes/mfem/build
```

To build MEPHIT, run

```bash
mkdir $MEPHIT_DIR
cmake -B $MEPHIT_DIR
cd $MEPHIT_DIR
make
```

### Coil geometry

In order to use the default configuration `vac_src = 2` (pre-computed Fourier modes for the vacuum field), create a namelist file for `coil_field`, like libneo's `tools/vacfield_AUG.in`, and run coil_tools once to generate `$MEPHIT_DIR/data/AUG_B_coils.h5`:

```bash
$LIBNEO_DIR/vacfield.x AUG 16 data/Bu{1..8}n.asc data/Bl{1..8}n.asc Fourier vacfield_AUG.in $MEPHIT_DIR/data/AUG_B_coils.h5
```

This should take about 20 minutes and the resulting file uses about 2 GB of disk space. This can then be used for `config%coil_file` in `mephit.in` (see below).

## Setting up working directories

```bash
$MEPHIT_DIR/scripts/mephit.bash init { -c | --config } <config> { -g | --g-eqdsk } <gfile> { -t | --type } { asdex | kilca } <working_directory> ...
```

This copies the `<config>`, `<gfile>`, and other necessary files to each given `<working_directory>`. The `<config>` file and some sample gfiles can be taken from a list of templates `mephit_<gfile>.in` in the `data` directory, e.g. [`data/mephit_g33353_2900_EQH.in`](data/mephit_g33353_2900.in). Currently, only geometry files for ASDEX Upgrade and KiLCA (large aspect ratio) are available.

The config file `mephit.in` needs do be adapated for each simulation:

- In the `arrays` namelist, array indices must be within the range of `m_res_min` and `m_res_max`.
- For ASDEX Upgrade, the data files containing coil geometry, coil currents, and kinetic profiles must be supplied.
- For KiLCA, the requested poloidal mode must be set in `config%kilca_pol_mode`. For `config%kilca_scale_factor`, a value of `1000` yields reasonable results. Last but not least, the HDF5 output of the KiLCA vacuum run has to provied via `config%kilca_vac_output`.

## Simulations

Simulations consist of three phases:

1. meshing (includes calculation of the vacuum field)
2. preconditioner
3. iterations

Each phase can be run separately by specifying the corresponding command line switch; if none are given, all phases are run by default. Use `--debug` to start a [GDB](https://www.gnu.org/software/gdb) session, `--memcheck` to run [Valgrind's Memcheck](https://valgrind.org/info/tools.html#memcheck), or `--test` to run internal tests (expensive, ignores phases). If no working directory is given, the current directory is used. If a file is given, it is used as an input namelist; if a directory is given, all files with pattern `mephit*.in` in it are used consecutively. Non-existing directories or files are skipped.

```bash
$MEPHIT_DIR/scripts/mephit.bash run [-m | --meshing] [-p | --preconditioner] [-i | --iterations] [--debug | --memcheck | --test] [<working_directory_or_file> ...]
```

### Plots

Default plots are generated by running

```bash
$MEPHIT_DIR/scripts/mephit.bash plot [<working_directory> ...]
```

### Cleanup

```bash
$MEPHIT_DIR/scripts/mephit.bash clean [<working_directory> ...]
```

This removes all files generated by the `run` and `plot` commands in each `<working_directory>`.

## Documentation

To generate documentation, run the following commands.

```bash
cd DOC
latexmk magdif.tex
doxygen doxygen.conf
```

While both the LaTeX documentation of the method and the Doxygen documentation of the source code are horribly out of date, the `EXTRACT_ALL = YES` option of Doxygen is useful for generating call graphs.
