# How to run

Prerequisites for running NEO-EQ are as follows.

- current GNU/Linux environment (Bash, coreutils, getopt, ...)
- current Fortran compiler (tested with `gfortran` >= 9.2.0 and `ifort` 18.0.1)
- [CMake](https://cmake.org/)
- [LAPACK](https://www.netlib.org/lapack/)
- [SuiteSparse](https://github.com/DrTimothyAldenDavis/SuiteSparse)
- [SuperLU](https://github.com/xiaoyeli/superlu)
- [GSL](https://www.gnu.org/software/gsl/) and [FGSL](https://github.com/reinh-bader/fgsl)
- [FFTW3](http://fftw.org/)
- [FreeFem++](https://github.com/FreeFem/FreeFem-sources)
- [HDF5](https://www.hdfgroup.org/downloads/hdf5)
- [NetCDF](https://github.com/Unidata/netcdf-fortran)
- Python 3 including the following packages:
  - [NumPy](https://github.com/numpy/numpy)
  - [SciPy](https://github.com/scipy/scipy)
  - [matplotlib](https://github.com/matplotlib/matplotlib)
  - [colorcet](https://github.com/holoviz/colorcet)
  - [h5py](https://github.com/h5py/h5py)
  - [h5pickle](https://github.com/DaanVanVugt/h5pickle)
  - [netcdf4-python](https://github.com/Unidata/netcdf4-python)

## Initial build

Set the environment variables `LIBNEO_DIR` and `FGSL_PATH` if libneo and FGSL are not in their default location (adjacent to MEPHIT and in the system default, respectively). At ITPcp, you can put the following into your `~/.bashrc` for testing:

    export LIBNEO_DIR=/temp/lainer_p/git/libneo
    export FGSL_PATH=/temp/lainer_p/fgsl-1.2.0/LIB

To build MEPHIT, run

    mkdir build
    cd build
    cmake ..
    make

## Coil geometry conversions

    build/bin/mephit convert <input_type> <output_type> <source_directory> [<target_directory>]

Converts coil geometry of `<input_type>` to `<output_type>`, reading appropriately named files from `<source_directory>` and writing to `<target_directory>`. If `<target_directory>` does not exist, it is created, and if it is omitted, it is set to the same value as `<source_directory>`. Possible values for `<input_type>` are `AUG`, `GPEC`, and `Nemov`. Possible values for `<output_type>` are `Fourier`, `GPEC`, and `Nemov`.

In order to use the default configuration `vac_src = 2` (pre-computed Fourier modes), run

    build/bin/mephit convert AUG Fourier data

once to generate `data/AUG_B_coils.h5` which should take about 20 minutes and uses about 2 GB of disk space.

## Setting up working directories

    build/bin/mephit init -c <config> -g <gfile> -t { asdex | kilca } <working_directory> ...

This copies the `<config>`, `<gfile>`, and other necessary files to each given `<working_directory>`. The `<config>` file can be taken from a list of templates `mephit_<gfile>.in` in the `data` directory.

## Simulations

Simulations consist of three phases:

1. meshing (includes calculation of the vacuum field)
2. iterations
3. analysis (poloidal modes, parallel currents)

Each phase can be run separately by specifying the corresponding command line switch; if none are given, all phases are run by default.

    build/bin/mephit run [-m | --meshing] [-i | --iterations] [-a | --analysis] <working_directory> ...


## Plots

Default plots are generated by running

    build/bin/mephit plot <working_directory> ...

## Cleanup

    build/bin/mephit clean <working_directory> ...

This removes all files generated by the `run` and `plot` commands in each `<working_directory>`.
