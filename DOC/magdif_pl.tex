\documentclass[a4paper, 10pt, english]{article}
\setlength\overfullrule{5pt}

% (La)TeX stuff
\usepackage{etoolbox}

% fonts and maths
\usepackage{fontspec}
%\setmainfont{TeX Gyre Pagella}
%\setsansfont{TeX Gyre Heros}
%\setmonofont[Scale=MatchLowercase]{Source Code Pro}
\usepackage{microtype}
\usepackage{amsmath}  % [fleqn]
\allowdisplaybreaks[1]
%\numberwithin{equation}{section}
\usepackage[math-style=ISO, bold-style=ISO]{unicode-math}
\DeclareSymbolFont{AMSb}{U}{msb}{m}{n}
\protected\def\mathbb#1{{\mathchar\numexpr256*\symAMSb+`#1\relax}}
\AtBeginDocument{%
  \let\temp\vartheta
  \let\vartheta\theta
  \let\theta\temp
  \let\temp\varphi
  \let\varphi\phi
  \let\phi\temp
  \let\vecarr\vec
  \let\vec\symbf
}

% language
\usepackage{polyglossia}
\setmainlanguage{english}
\usepackage{csquotes}
\MakeOuterQuote{"}

% tables
\usepackage{array}
%\usepackage{tabularx}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{subcaption}

% graphics
\usepackage{xcolor}
\newcommand\comment[1]{\begingroup\color{red}[#1]\endgroup}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{tikz}

% import and display data
\usepackage{siunitx}
\sisetup{
  %locale=DE,
  group-digits=false,
  add-decimal-zero=false,
  separate-uncertainty,
  round-mode=figures,
  round-precision=2,
  table-number-alignment=left,
  detect-mode=true}

% page layout
\raggedbottom
\tolerance=2000
\usepackage{enumitem}
\setlist{align=left}
\usepackage{parskip}
\usepackage{lastpage}
\usepackage[margin=2cm, head=15pt, includehead, includefoot]{geometry}
\usepackage[bottom, stable, perpage]{footmisc}
\usepackage{fancyhdr}
\cfoot{\thepage/\pageref{LastPage}}
\pagestyle{fancy}
\renewcommand{\sectionmark}[1]{\markboth{\thesection~#1}{}}
\renewcommand{\subsectionmark}[1]{\markright{\thesubsection~#1}}

% front and back matter
\usepackage{eso-pic}
\usepackage[backend=biber, bibstyle=numeric, citestyle=authoryear, sorting=none, maxcitenames=1, maxbibnames=5]{biblatex}
\renewcommand*\finalnamedelim{,\ }
\DefineBibliographyStrings{english}{%
  andothers        = {et\,al\adddot},
  andmore          = {et\,al\adddot}
}
\usepackage[
% pdfa         = true,
  unicode      = true,
  bookmarks    = true,
  colorlinks   = true,
  linkcolor    = black,
  urlcolor     = black,
  citecolor    = black,
  pdfstartview = FitH
2  ]{hyperref}
\usepackage{cleveref}
\hypersetup{
  pdftitle           = {Magnetic differential equations for stationary linear ideal MHD and their numerical solution},
  pdfauthor          = {Christoper Albert, Patrick Lainer},
  pdfsubject         = {write-up},
  pdfkeywords        = {magnetohydrodynamics},
  pdflang            = {en}
}

% debugging
%\usepackage[inline]{showlabels}
%\usepackage[notref]{showkeys}

\title{Magnetic differential equations for stationary linear ideal MHD and their numerical solution}
\author{Christopher Albert, Patrick Lainer}

% math shortcuts etc.
\newcommand*\diff{\ensuremath{\symrm{d}}}  % differential
\newcommand*\e{\ensuremath{\symrm{e}}}  % Euler's constant
\newcommand*\im{\ensuremath{\symrm{i}}}  % imaginary unit
\newcommand*\pd[2][]{\ensuremath{\frac{\partial #1}{\partial #2}}}  % partial derivative
\newcommand*\norm[1]{\ensuremath{\left \lVert #1 \right \rVert}}  % norm
\newcommand*\pol{\ensuremath{\textrm{pol}}}  % poloidal
\newcommand*\tor{\ensuremath{\textrm{tor}}}  % toroidal
\newcommand*\fs{\ensuremath{\textrm{f}}}  % flux surface edge label
\newcommand*\inw{\ensuremath{\textrm{i}}}  % inward current edge label
\newcommand*\out{\ensuremath{\textrm{o}}}  % outward current edge label
\newcommand*\vfs{\ensuremath{\textrm{F}}}  % label for vertex opposite flux surface edge
\newcommand*\vinw{\ensuremath{\textrm{I}}}  % label for vertex opposite inward current edge
\newcommand*\vout{\ensuremath{\textrm{O}}}  % label for vertex opposite outward current edge
\DeclareMathOperator\Real{Re}
\DeclareMathOperator\Imag{Im}

\begin{document}

\maketitle
\tableofcontents

\section{Stationary linear perturbation of ideal MHD equilibrium}

For the intended application on stationary (compared to MHD mode eigenfrequencies) non-axisymmetric magnetic perturbations by external coils, we consider a perturbed ideal MHD equilibrium for pressure $p$, currents $\vec{j}$ and magnetic field $\vec{B}$ fulfilling
\begin{align}
  \nabla p &= \frac{1}{c} \vec{j} \times \vec{B}, \label{eq:mhd-gen} \\
  \nabla \times \vec{B} &= \frac{4 \pi}{c} \vec{j}, \label{eq:ampere-gen} \\
  \nabla \cdot \vec{B} &= 0. \label{eq:divfree-gen}
\end{align}
Starting with a given MHD equilibrium fulfilling \cref{eq:mhd-gen,eq:divfree-gen} denoted by subscripts "$0$", linear order equations for an external magnetic perturbation (denoted by $\delta$) split into a vacuum and a plasma part (subscript $\text{v}$ and $\text{p}$, respectively) are
\begin{align}
  \nabla \delta p &= \frac{1}{c} \left( \vec{j}_{0} \times \delta \vec{B} + \delta \vec{j} \times \vec{B}_{0} \right), \label{eq:mhd} \\
  \delta \vec{B} &= \delta \vec{B}_{\text{v}} + \delta \vec{B}_{\text{p}}, \\
  \delta \vec{B}_{\text{v}} &= \frac{1}{c} \oint \frac{I_{\text{c}}(\vec{r}') \, \diff \vec{l}' \times \vec{r}}{\lvert \vec{r} - \vec{r}' \rvert^{3}}, \\
  \delta \vec{B}_{\text{p}} &= \nabla \times \delta \vec{A}, \\
  \nabla \times (\nabla \times \delta \vec{A}) &= \frac{4 \pi}{c} \delta \vec{j}, \label{eq:ampere} \\
  \Rightarrow \nabla \cdot \delta \vec{B} &= \nabla \cdot \delta \vec{j} = 0. \label{eq:divfree}
\end{align}
Here the perturbation field in vacuum, $\delta \vec{B}_{\text{v}}$, is pre-evaluated by a Biot-Savart integral over external coil currents $I_{\text{c}}(\vec{r}')$ and the perturbation field in plasma $\delta \vec{B}_{\text{p}}$ is computed from Amp√®re's law (\ref{eq:ampere}) from the plasma current density $\delta \vec{j}$ using a vector potential formulation. To find a consistent solution for the system, \cref{eq:mhd} and \cref{eq:ampere} are treated individually in an iterative way. The linearized force balance equation~\eqref{eq:mhd} is used to compute $\delta \vec{j}$ for given $\delta \vec{B}$ whereas \cref{eq:ampere} yields $\delta \vec{B}_{\text{p}}$ for given $\delta \vec{j}$. In the first iteration, $\delta \vec{B}$ is set equal to $\delta \vec{B}_{\text{v}}$ in \cref{eq:mhd}. Then, \cref{eq:ampere} and \cref{eq:mhd} are solved in an alternating way until convergence is reached. In addition a preconditioner is used to enhance convergence. Here we limit the analysis to an axisymmetric unperturbed equilibrium and a single toroidal perturbation harmonic $\delta \vec{B} = \Real (\vec{B}_{n} \e^{\im n \phi})$ with a similar notation for other perturbed quantities. As all equations are linear, a superposition of multiple harmonics is easily possible. Note that $n \neq 0$; such a perturbation is necessarily small and considered part of the axisymmetric equilibrium.
% clarify why/whether $n = 0$ is in fact negligible

\section{Linearized MHD force balance}

The solution of \cref{eq:mhd} can further be split into two steps: First the pressure perturbation $\delta p$ is found, and then the plasma current density $\delta \vec{j}$ is computed using the condition $\nabla \cdot \delta \vec{j} = 0$. For an unperturbed equilibrium with nested flux surfaces, both steps can be performed in a radially local manner if a field-aligned computational grid is used, which will become clear below. Radial coupling happens by the combination of the two individual steps since their effective radial locations of computation are shifted by a half-step in radial grid distance.

\subsection{Geometrical considerations}

In axisymmetric coordinate systems, such as cylindrical $(R, \phi, Z)$, the equations to solve for harmonics in the toroidal angle $\phi$ are
\begin{align}
  \nabla p_{n} + \im n p_{n} \nabla \phi &= \frac{1}{c} \left( \vec{j}_{0} \times \vec{B}_{n} + \vec{j}_{n} \times \vec{B}_{0} \right), \label{eq:mhd-phi} \\
  \nabla \cdot \vec{j}_{n}^{\pol}+ \im n j_{n}^{\phi} &= 0. \label{eq:divfree-phi}
\end{align}
now with a 2D $\nabla$ operator acting in the poloidal ($RZ$) plane. The divergence operator is defined via
\begin{gather*}
  \nabla \cdot \vec{u} = \frac{1}{R \sqrt{g_{\pol}}} \pd{x^{k}} (R \sqrt{g_{\pol}} u^{k}),
\end{gather*}
where $\sqrt{g_{\pol}}$ is the metric tensor of the coordinates in the poloidal plane, which is equal to $1$ for cylindrical coordinates.

The representation of equilibrium field $\vec{B}_{0}$ is given by
\begin{gather}
  \vec{B}_{0} = \vec{B}_{0}^{\pol} + \vec{B}_{0}^{\tor},
\end{gather}
where 
\begin{align}
  \vec{B}_{0}^{\pol} &= \nabla \psi \times \nabla \phi, \\
  \vec{B}_{0}^{\tor} &= B_{0 \phi} \nabla \phi.
\end{align}
This leads to the following contravariant components for $\vec{B}_{0}^{\pol}$ in cylindrical coordinates:
\begin{align}
  B_{0}^{R} &= (\nabla \psi \times \nabla \phi)^{R} = -\frac{1}{R} \pd[\psi]{Z}, \\
  B_{0}^{Z} &= (\nabla \psi \times \nabla \phi)^{Z} = \frac{1}{R} \pd[\psi]{R}.
\end{align}

\begin{figure}
  \centering
  \begin{subfigure}[b]{0.33\textwidth}
    \centering
    \input{grid0.tpx}
    \caption{The innermost loop of the grid with the magnetic axis at its center. Edge \fs\ lies on the flux surface in the infinitesimal limit.}
    \label{fig:grid0}
  \end{subfigure}
  \quad
  \begin{subfigure}[b]{0.5\textwidth}
    \centering
    \input{grid1.tpx}
    \caption{One of the outer loops of the grid with two alternating kinds of triangles with edge \fs\ lying on the inner and outer flux surface respectively.}
    \label{fig:grid1}
  \end{subfigure}
  \caption{The 2D mesh is given by a triangulation of poloidal cross-sections of the nested flux surfaces, resulting in \enquote{loops}. The cross-sections are assumed to be circular for illustration purposes.}
  \label{fig:grid}
\end{figure}

\subsubsection{Coordinate system on each edge}

For each edge (length $l$) we use a local orthogonal coordinate system on each triangle edge with $\vec{l}$ the vector of length $l$ along the edge in counter-clockwise orientation, $\vec{n}$ the outward normal of length $l$ and $\nabla \phi$ pointing inside the plane. We obtain relations
\begin{align}
  \vec{l} \times \vec{n} &= l^{2} R \nabla \phi, \\
  \vec{n} \times R \nabla \phi &= \vec{l}, \\
  R \nabla \phi \times \vec{l} &= \vec{n}.
\end{align}

\subsection{Pressure perturbation}

Multiplying \cref{eq:mhd-phi} by $\vec{B}_{0}$ yields
\begin{align}
  c \vec{B}_{0} \cdot \nabla p_{n} + \im n c p_{n} \vec{B}_{0} \cdot \nabla \phi &= -\vec{B}_{n} \cdot (\vec{j}_{0} \times \vec{B}_{0}) = -c \vec{B}_{n} \cdot \nabla p_{0} \nonumber \\
  \vec{B}_{0}^{\pol} \cdot \nabla p_{n} + \im n p_{n} B_{0}^{\phi} &= -B_{n}^{\psi} p_{0}'(\psi). \label{eq:pn}
\end{align}
To solve this equation on one flux surface, we use a lowest-order finite difference method. Nodes are indexed by superscript $(k)$ and $\vec{r}^{(k)}$ is the position of node $(k)$. $\nabla p_{n}$ is approximated at the midpoint of edge $\Gamma_{k}$ as finite difference of $p_{n}$ at nodes $(k)$ and $(k+1)$. $p_{n}$ is accordingly approximated at the midpoint as the arithmetic mean of the values at these nodes. This results in
\begin{gather*}
  \vec{B}_{0}^{\pol} \cdot \frac{\vec{r}^{(k+1)} - \vec{r}^{(k)}}{\norm{\vec{r}^{(k+1)} - \vec{r}^{(k)}}} \frac{p_{n}^{(k+1)} - p_{n}^{(k)}}{\norm{\vec{r}^{(k+1)} - \vec{r}^{(k)}}} + \im n B_{0}^{\phi} \frac{p_{n}^{(k+1)} + p_{n}^{(k)}}{2} = -p_{0}'(\psi) B_{n}^{\psi} \vert_{\Gamma_{k}},
\end{gather*}
where a unit vector along the edge is used to get the correct sign for the gradient in the direction of the poloidal magnetic field; with a shorthand $\symup{\Delta} r$ for the distance between nodes we get
\begin{gather}
  \vec{B}_{0}^{\pol} \cdot \frac{\vec{r}^{(k+1)} - \vec{r}^{(k)}}{(\symup{\Delta} r)^2} \left ( p_{n}^{(k+1)} - p_{n}^{(k)} \right ) + \im n B_{0}^{\phi} \frac{p_{n}^{(k+1)} + p_{n}^{(k)}}{2} = -p_{0}'(\psi) B_{n}^{\psi} \vert_{\Gamma_{k}}.
\end{gather}
Reordering in terms of the unknowns yields
\begin{gather}
  (b_{k} + a_{k}) p_{n}^{(k+1)} + (b_{k} - a_{k}) p_{n}^{(k)} = c_{k}
\end{gather}
with
\begin{align}
  a_{k} &= \vec{B}_{0}^{\pol} \cdot \frac{\vec{r}^{(k+1)} - \vec{r}^{(k)}}{(\symup{\Delta} r)^2}, \\
  b_{k} &= \frac{\im n B_{0}^{\phi}}{2}, \\
  c_{k} &= -p_{0}'(\psi) B_{n}^{\psi} \vert_{\Gamma_{k}}.
\end{align}
In matrix form this scheme is written as
\begin{gather}
  A_{jk} p_{n}^{k} = c_{j},
\end{gather}
where the elements of the stiffness matrix are
\begin{gather}
  A_{jk} = (b_{j} + a_{j}) \delta_{j-1, k} + (b_{j} - a_{j}) \delta_{jk}.
\end{gather}
Note that for $N$ nodes with periodic boundary conditions $p_{n}^{(N+1)} = p_{n}^{(1)}$, indices are taken \emph{modulo} $N$, resulting in the following shape for the stiffness matrix:
\begin{gather*}
  A = \begin{pmatrix}
    b_{1} - a_{1} &  b_{1} + a_{1} &        0       & \hdots &    0   \\
           0       & b_{2} - a_{2} &  b_{2} + a_{2} & \hdots &    0   \\
           0       &        0       & b_{3} - a_{3} & \hdots &    0   \\
        \vdots     &     \vdots     &     \vdots     & \ddots & \vdots \\
     b_{N} + a_{N} &        0       &        0       & \hdots & b_{N} - a_{N}
  \end{pmatrix}.
\end{gather*}

\subsubsection{Analytical solution for very large aspect ratios}

Using flux coordinates $(r, \theta, \phi)$, a term in \cref{eq:pn} can be simplified:
\begin{gather}
  \vec{B}_{0}^{\pol} \cdot \nabla p_{n} = B_{0}^{\theta} \vec{e}_{\theta} \cdot \nabla p_{n} = B_{0}^{\theta} \pd[p_{n}]{\theta}.
\end{gather}
Now when we expand the perturbed quantities as series in $\theta$ as well as $\phi$ so that
\begin{gather}
  \delta p = \sum_{n} p_n(r, \theta) \e^{\im n \phi} = \sum_{m, n} p_{mn}(r) \e^{\im m \theta + \im n \phi},
\end{gather}
\cref{eq:pn} reduces to
\begin{gather}
  \im m p_{mn} B_{0}^{\theta} + \im n p_{mn} B_{0}^{\phi} = -B_{mn}^{r} p_{0}'(r) =: -q_{mn}
\end{gather}
with a source term $q_{mn}$. This allows a simple algebraic solution where all quantities depend only on $r$:
\begin{gather}
  p_{mn} =  \frac{\im q_{mn}}{m B_{0}^{\theta} + n B_{0}^{\phi}}.
\end{gather}
Now an approximation can be made by switching from contravariant components to covariant components which are (for some reason) assumed to be constant. The factor $R$ appearing in the metric components can also be considered constant over the domain in question -- the toroidal geometry is effectively transformed to cylindrical geometry with a very thin and elongated cylinder and periodic boundary conditions.

\subsection{Current perturbation}

Multiplying \cref{eq:divfree-phi} by $R$ yields
\begin{gather}
  \pd{x^{k}} (R j_{n}^{k}) + \im n R j_{n}^{\phi} = 0.
\end{gather}
Using the divergence theorem this can also be written in integral form in a specific triangular mesh element $\Omega^{(i)}$ as
\begin{gather}
  \oint_{\partial \Omega^{(i)}} \diff l \, R \vec{j}_{n} \cdot \hat{\vec{n}} + \im n \int_{\Omega^{(i)}} \diff R \, \diff Z \, R j_{n}^{\phi} = 0.
\end{gather}
Here the first integral is performed over the 1-dimensional element boundary $\partial \Omega^{(i)} = \Gamma^{(i)}$. The first term is split into three contributions,
\begin{gather}
  \oint_{\partial \Omega^{(i)}} \diff l \, R \vec{j}_{n} \cdot \hat{\vec{n}} = \int_{\Gamma_{\inw}^{(i)}, \Gamma_{\out}^{(i)}} \diff l \, R \vec{j}_{n} \cdot \hat{\vec{n}} + \int_{\Gamma_{\fs}^{(i)}} \diff l \, R \vec{j}_{n} \cdot \hat{\vec{n}},
\end{gather}
where edge \fs\ is tangential to an adjacent flux surface and edges \inw\ and \out\ are not. For the grid it is important to distinguish two types of triangles, starting from the second loop outside the magnetic axis, see \cref{fig:grid}.

\subsubsection{Toroidal unperturbed current}

Since $\vec{B}_{0}$ and $p_{0}$ are directly available as input data, but $\vec{j}_{0}$ is not, the latter will be derived below from \cref{eq:mhd-gen}, the condition of divergence-freeness and symmetry considerations.

We take a cross-product of \cref{eq:mhd-gen} by $\vec{B}_{0}$:
\begin{align}
  \vec{B}_{0} \times \left( \vec{j}_{0} \times \vec{B}_{0} \right) &= B_{0}^{2} \vec{j}_{0} - (\vec{B}_{0} \cdot \vec{j}_{0}) \vec{B}_{0} \nonumber \\
  &= B_{0}^{2} (\vec{j}_{0} - j_{0 \parallel} \vec{h}_{0}) \nonumber \\
  &= B_{0}^{2} \vec{j}_{0 \perp}.
\end{align}
Therefore
\begin{align}
  \vec{j}_{0 \perp} &= \frac{-c \nabla p_{0} \times \vec{B}_{0}}{B_{0}^{2}} \\
  &= \frac{-c p_{0}' (\psi) \nabla \psi \times (\nabla \psi \times \nabla \phi + B_{0 \phi} \nabla \phi)}{B_{0}^{2}} \nonumber \\
  &= \frac{-c p_{0}' (\psi)}{B_{0}^{2}} \left( B_{0 \phi} \vec{B}_{0}^{\pol} - \lvert \nabla \psi \rvert^{2} \nabla \phi \right).
\end{align}
which is the diamagnetic current density. For the parallel current density we use
\begin{align}
 0 = \nabla \cdot \vec{j}_{0} &= \nabla \cdot \vec{j}_{0 \perp} + \nabla \cdot (j_{0 \parallel} \vec{h}_{0}) \nonumber \\
 &= -c \nabla \cdot \left( \frac{\nabla p_{0} \times \vec{B}_{0}}{B_{0}^{2}} \right) + \vec{B}_{0} \cdot \nabla \left( \frac{j_{0 \parallel}}{B_{0}} \right).
\end{align}
In straight-field line magnetic flux coordinates $(r, \theta, \phi)$ with Jacobian $\sqrt{g}$ and the divergence of the diamagnetic current is
\begin{align}
  \nabla \cdot \vec{j}_{0 \perp} &= -\frac{c}{\sqrt{g}} \pd{x^{k}} \left[ \frac{\sqrt{g}}{B_{0}^{2}} \left( \nabla p_{0} \times \vec{B}_{0} \right)^{k} \right] \nonumber \\
  &= -\frac{c}{\sqrt{g}} \pd{x^{k}} \left( \frac{\sqrt{g}}{B_{0}^{2}} \frac{\varepsilon^{ijk}}{\sqrt{g}} \pd[p_{0}]{x^{i}} B_{0 j} \right) \nonumber \\
  &= \frac{c p_{0}' (r) B_{0 \phi}}{\sqrt{g}} \pd{\theta} \left( \frac{1}{B_{0}^{2}} \right),
\end{align}
since $p_{0}$ and $B_{0 \phi}$ are constant on a flux surface, $\pd[p_{0}]{\theta} = 0$ and due to axisymmetry $\pd{\phi} = 0$. The divergence of the parallel current is
\begin{gather}
  \nabla \cdot(j_{0 \parallel} \vec{h}_{0}) = B_{0}^{\theta} \pd{\theta} \left( \frac{j_{0 \parallel}}{B_{0}} \right).
\end{gather}
With $\sqrt{g} B_{0}^{\theta} = \psi'(r)$ as a flux surface quantity, there are no dependencies of $\theta$ in front of the derivatives. Direct integration and a change of variables/notation as in
\begin{gather}
  \frac{p_{0}'(r)}{\psi'(r)} = \frac{\pd[p_{0}]{r}}{\pd[\psi]{r}} = \pd[p_{0}]{\psi} = p_{0}'(\psi)
\end{gather}
yields
\begin{gather}
  j_{0 \parallel} = -\frac{c p_{0}'(\psi) B_{0 \phi}}{B_{0}} + C(\psi) B_{0}.
\end{gather}
With the extra condition of the flux-surface average $\left\langle j_{0 \parallel} B_{0} \right\rangle = 0$ for testing without bootstrap current and the assumption $\left\langle B_{0 \phi} \right\rangle = B_{0 \phi}$, we obtain
\begin{align}
  0 &= -c p_{0}'(\psi) B_{0 \phi} + C(\psi) \left\langle B_{0}^{2} \right\rangle \nonumber \\
  \Rightarrow C(\psi) &= \frac{c p_{0}'(\psi) B_{0 \phi}}{\left\langle B_{0}^{2} \right\rangle}.
\end{align}
In general, 
\begin{align}
  C(\psi) &= \frac{c p_{0}'(\psi) B_{0 \phi}}{\left\langle B_{0}^{2} \right\rangle} D(\psi), \\
  j_{0 \parallel} &= -\frac{c p_{0}'(\psi) B_{0 \phi}}{B_{0}} \left( \frac{B_{0}^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) - 1 \right).
\end{align}
with $D(\psi)$ set to 1 for now and modified for the more general case $\left\langle j_{0 \parallel} B_{0} \right\rangle \not\equiv 0$.

For the unperturbed toroidal current density we have
\begin{gather}
  j_{0}^{\phi} = j_{0 \parallel} h_{0}^{\phi} + \vec{j}_{0 \perp} \cdot \nabla \phi,
\end{gather}
where
\begin{align}
  j_{0 \parallel} h_{0}^{\phi} &= -\frac{1}{B_{0}} c p_{0}'(\psi) B_{0 \phi} \frac{B_{0}^{\phi}}{B_{0}} \left( \frac{B_{0}^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) - 1 \right) \nonumber \\
  &= -c p_{0}'(\psi) \frac{\left( B_{0}^{\tor} \right)^{2}}{B_0^2} \left( \frac{B_{0}^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) - 1 \right) \nonumber \\
  &= -c p_{0}'(\psi) \left( B_{0}^{\tor} \right)^{2} \left( \frac{D(\psi)}{\left\langle B_{0}^{2} \right\rangle} - \frac{1}{B_{0}^{2}} \right).
\end{align}
and
\begin{align}
  \vec{j}_{0 \perp} \cdot \nabla \phi &= \frac{-c p_{0}'(\psi) \nabla \phi \cdot (\nabla \psi \times \vec{B}_{0})}{B_{0}^{2}} \nonumber \\
  &= \frac{-c p_{0}'(\psi) \vec{B}_{0} \cdot (\nabla \phi \times \nabla \psi)}{B_{0}^{2}} \\
  &= \frac{c p_{0}'(\psi)}{B_{0}^{2}} \vec{B}_{0}^{\pol} \cdot \vec{B}_{0} \nonumber \\
  &= c p_{0}'(\psi) \frac{\left( B_{0}^{\pol} \right)^{2}}{B_{0}^{2}}.
\end{align}
It follows from
\begin{gather}
  \left( B_{0}^{\pol} \right)^{2} + \left( B_{0}^{\tor} \right)^{2} = B_{0}^{2}
\end{gather}
that
\begin{gather}
  j_{0}^{\phi} = c p_{0}'(\psi) \left( 1 - \frac{\left( B_{0}^{\tor} \right)^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) \right).
\end{gather}

\subsubsection{Toroidal current perturbation}

For the computation of toroidal $j_{n}^{\phi}$ in the element volume we start from \cref{eq:mhd-phi} with
\begin{gather}
  \vec{j}_{n} \times \vec{B}_{0} = c (\nabla p_{n} + \im n p_{n} \nabla \phi) - \vec{j}_{0} \times \vec{B}_{n} \label{eq:jnxB0}
\end{gather}
and
\begin{gather}
  \vec{B}_{0} = \nabla \psi \times \nabla \phi + B_{0 \phi} \nabla \phi.
\end{gather}
Taking a scalar product of $\vec{l}$ with \cref{eq:jnxB0} on some edge yields
\begin{align}
  \vec{l} \cdot (\vec{j}_{n} \times \vec{B}_{0}) &= \vec{l} \cdot (\vec{j}_{n} \times (\nabla \psi \times \nabla \phi + B_{0 \phi} \nabla \phi)) \nonumber \\
  &= \vec{j}_{n} \cdot ((\nabla \psi \times \nabla \phi) \times \vec{l} + B_{0 \phi} \nabla \phi \times \vec{l}) \nonumber \\
  &= \vec{j}_{n} \cdot ((\nabla \psi \times \nabla \phi) \times \vec{l} + B_{0 \phi} \vec{n} / R) \nonumber \\
  &= \vec{j}_{n} \cdot \left( (\vec{l} \cdot \nabla \psi) \nabla \phi + B_{0 (\phi)} \vec{n} \right) \nonumber \\
  &= (\vec{l} \cdot \nabla \psi) j_{n}^{\phi} + B_{0 (\phi)} \vec{j}_{n}^{\pol} \cdot \vec{n}.
\end{align}
Further,
\begin{gather}
  \vec{l} \cdot \nabla \psi = R \nabla \psi \cdot \left( \vec{n} \times \nabla \phi \right) = -R \vec{n} \cdot \vec{B}_{0}^{\pol}.
\end{gather}
Finally,
\begin{gather}
  \vec{l} \cdot (\vec{j}_{n} \times \vec{B}_{0}) = B_{0 (\phi)} \vec{j}_{n}^{\pol} \cdot \vec{n} - R j_{n}^{\phi} \vec{n} \cdot \vec{B}_{0}^{\pol}.
\end{gather}
The right-hand side of \cref{eq:jnxB0} yields:
\begin{align}
  \vec{l} \cdot (\nabla p_{n} + \im n p_{n} \nabla \phi) &= \vec{l} \cdot \nabla p_{n} \\
  \vec{l} \cdot (\vec{j}_{0} \times \vec{B}_{n}) &= \vec{l} \cdot (B_{n \phi} \vec{j}_{0}^{\pol} \times \nabla \phi + j_{0 \phi} \nabla \phi \times \vec{B}_{n}^{\pol}).
\end{align}
We use the fact that $\nabla p_{0}$ is parallel to $\nabla \psi$, so the cross product in the equilibrium is purely radial,
\begin{align}
  \vec{j}_{0} \times \vec{B}_{0} &= c \nabla p_{0} \nonumber \\
  &= \vec{j}_{0}^{\pol} \times (B_{0 \phi} \nabla \phi) + j_{0 \phi} \nabla \phi \times (\nabla \psi \times \nabla \phi) \nonumber \\
  &= \vec{j}_{0}^{\pol} \times (B_{0 \phi} \nabla \phi) + \frac{j_{0 \phi}}{R^{2}} \nabla \psi.
\end{align}
Thus
\begin{gather}
  \vec{j}_{0}^{\pol} \times \nabla \phi = \frac{1}{B_{0 \phi}} \left( c \nabla p_{0} - \frac{j_{0 \phi}}{R^{2}} \nabla \psi \right).
\end{gather}
Also
\begin{align}
  \vec{l} \cdot (\nabla \phi \times \vec{B}_{n}^{\pol}) &= \vec{B}_{n}^{\pol} \cdot (\vec{l} \times \nabla \phi) \nonumber \\
  &= -\frac{1}{R} \vec{B}_{n}^{\pol} \cdot \vec{n}.
\end{align}
Finally
\begin{gather}
  (\vec{l} \cdot \nabla \psi) j_{n}^{\phi} + B_{0 (\phi)} \vec{j}_{n}^{\pol} \cdot \vec{n} = c \vec{l} \cdot \nabla p_{n} - \frac{B_{n \phi}}{B_{0 \phi}} \left( c \vec{l} \cdot \nabla p_{0} - \frac{j_{0 \phi}}{R^{2}} \vec{l} \cdot \nabla \psi \right) + \frac{j_{0 \phi}}{R} \vec{B}_{n}^{\pol} \cdot \vec{n} \label{eq:jnphi-jnpol}
\end{gather}
This term is only meaningful to obtain $j_{n}^{\phi}$ on edges where $\vec{l} \cdot \nabla \psi \neq 0$ (\inw\ and \out\ in \cref{fig:grid}) and we obtain
\begin{gather}
  R j_{n}^{\phi} = j_{n (\phi)} = -\frac{B_{0 \phi}}{\vec{l} \cdot \nabla \psi} \vec{j}_{n}^{\pol} \cdot \vec{n} + \frac{c R}{\vec{l} \cdot \nabla \psi} \left( \vec{l} \cdot \nabla p_{n} - \frac{B_{n \phi}}{B_{0 \phi}} \vec{l} \cdot \nabla p_{0} \right) + j_{0 \phi} \left( \frac{B_{n \phi}}{R B_{0 \phi}} + \frac{\vec{B}_{n}^{\pol} \cdot \vec{n}}{\vec{l} \cdot \nabla \psi} \right). \label{eq:jnphi}
\end{gather}
In the implementation, an average over edge \inw\ and \out\ will be taken for this quantity.

On edge \fs, no connection between $j_{n}^{\phi}$ and $\vec{j}_{n}^{\pol} \cdot \vec{n}$ can be made, but the latter expression can be given in terms of already knwown quantities:
\begin{gather}
  R \vec{j}_{n}^{\pol} \cdot \vec{n} = \frac{c R}{B_{0 (\phi)}} \vec{l} \cdot \nabla p_{n} + \frac{j_{0 \phi}}{B_{0 (\phi)}} \vec{B}_{n}^{\pol} \cdot \vec{n}. \label{eq:If}
\end{gather}

\subsubsection{Alternative formulation for the current through flux surface edges}

As an alternative to \cref{eq:If} it can be shown (see writeup on gyrokinetics) that
\begin{align}
  \vec{j}_{n \perp} &= \vec{j}_{n} - (\vec{j}_{n} \cdot \vec{h}_{0}) \vec{h}_{0} \nonumber \\
  &= j_{0 \parallel} \frac{\vec{B}_{n \perp}}{B_{0}} - \frac{c B_{n \parallel}}{B_{0}^{2}} \vec{h}_{0} \times \nabla p_{0} + \frac{c}{B_{0}} \vec{h}_{0} \times (\nabla p_{n} + \im n p_{n} \nabla \phi).
\end{align}
Scalar multiplication with $\vec{n}_{\fs} \parallel \nabla p_{0} \parallel \nabla \psi \perp \vec{h}_{0}$ -- the first relation is true for infinitesimally small triangles -- yields
\begin{align}
  \vec{j}_{n \perp} \cdot \vec{n}_{\fs} = \vec{j}_{n \perp}^{\pol} \cdot \vec{n}_{\fs} &= j_{0 \parallel} \frac{\vec{B}_{n} \cdot \vec{n}_{\fs}}{B_{0}} + \frac{c}{B_{0}} \vec{n}_{\fs} \cdot (\vec{h}_{0} \times (\nabla p_{n} + \im n p_{n} \nabla \phi)) \nonumber \\
  &= j_{0 \parallel} \frac{\vec{B}_{n} \cdot \vec{n}_{\fs}}{B_{0}} + \frac{c}{B_{0}} \vec{n}_{\fs} \cdot (h_{0 \phi} \nabla \phi \times \nabla p_{n} + \im n p_{n} \vec{h}_{0}^{\pol} \times \nabla \phi) \nonumber \\
  &= j_{0 \parallel} \frac{\vec{B}_{n} \cdot \vec{n}_{\fs}}{B_{0}} + \frac{c}{B_{0}} (h_{0 \phi} \nabla p_{n} \cdot (\vec{n}_{\fs} \times \nabla \phi) + \im n p_{n} \vec{h}_{0}^{\pol} \cdot (\nabla \phi \times \vec{n}_{\fs})) \nonumber \\
  &= j_{0 \parallel} \frac{\vec{B}_{n} \cdot \vec{n}_{\fs}}{B_{0}} + \frac{c}{R B_{0}} \vec{l}_{\fs} \cdot (h_{0 \phi} \nabla p_{n} - \im n p_{n} \vec{h}_{0}^{\pol}) \nonumber \\
  &= j_{0 \parallel} \frac{\vec{B}_{n} \cdot \vec{n}_{\fs}}{B_{0}} + \frac{c}{B_{0}^{2}} \vec{l}_{\fs} \cdot \left( B_{0 (\phi)} \nabla p_{n} - \frac{\im n}{R} p_{n} \vec{B}_{0}^{\pol} \right). \label{eq:I3_alt}
\end{align}

\subsubsection{Implementation}

We start with
\begin{gather}
  I_{\inw} + I_{\out} + \im n \int_{\Omega} R j_{n}^{\phi} \diff S = -I_{\fs},
\end{gather}
where the notation for currents through edges, weighted by $R$, is
\begin{gather}
  I_{k} = \int_{\Gamma_{k}} R \vec{j}_{n}^{\pol} \cdot \hat{\vec{n}} \, \diff l \approx R_{k} \vec{j}_{n}^{\pol} \cdot \vec{n}_{k},
\end{gather}
where values are taken at the midpoint of edge $\Gamma_{k}$ and assumed to be constant along that edge. $I_{\fs}$ is already known from \cref{eq:If} or \cref{eq:I3_alt}
% \begin{gather}
%   I_{\fs} = j_{0 \parallel} R_{\fs} \frac{\vec{B}_{n} \cdot \vec{n}_{\fs}}{B_{0}} + \frac{c}{B_{0}^{2}} \vec{l}_{\fs} \cdot \left( R_{\fs} B_{0 (\phi)} \nabla p_{n} - \im n p_{n} \vec{B}_{0}^{\pol} \right),
% \end{gather}
and therefore acts as a source on the right-hand side. The remaining currents $I_{\inw}$ and $I_{\out}$ are taken as unknowns and appear also in the last term of the left-hand side as
\begin{align}
  \im n \int_{\Omega} R j_{n}^{\phi} \, \diff S & \approx \im n S_{\Omega} \frac{R_{\inw} j_{n \inw}^{\phi} + R_{\out} j_{n \out}^{\phi}}{2} \nonumber \\
  &= -\frac{\im n S_{\Omega}}{2} \left( \frac{B_{0 (\phi), \inw}}{\vec{l}_{\inw} \cdot \nabla \psi} I_{\inw} + \frac{B_{0 (\phi), \out}}{\vec{l}_{\out} \cdot \nabla \psi} I_{\out} + \dotsb \right),
\end{align}
where $S_{\Omega}$ is the triangle surface area. In the approximation above, a term $R_{\fs} j_{n \fs}^{\phi}$ is neglected because within one loop of triangles in \cref{fig:grid1}, edge \fs\ alternates between the inner and outer flux surface and this "oscillation" of sample points would carry over to the approximation values. Furthermore, $R_{\fs} j_{n \fs}^{\phi}$ can't be reformulated in terms of $R_{\fs} j_{n \fs}^{\phi}$, introducing another unknown. This would lead to an overdetermined set of equations, possibly violating divergence-freeness. Instead, $j_{n (\phi)}$ is approximated for each triangle by
\begin{gather}
  \im n \int_{\Omega} R j_{n}^{\phi} \approx \im n I_{(\phi)}.
\end{gather}
The remaining terms are moved to the right-hand-side as sources $q$, so the discretized equation in each triangle $\Omega$ is
\begin{gather}
  \left( 1 - \frac{\im n S_{\Omega}}{2} \frac{B_{0 (\phi)} \vert_{\Gamma_{\inw}}}{\vec{l}_{\inw} \cdot \nabla \psi} \right) I_{\inw} + \left( 1 - \frac{\im n S_{\Omega}}{2} \frac{B_{0 (\phi)} \vert_{\Gamma_{\out}}}{\vec{l}_{\out} \cdot \nabla \psi} \right) I_{\out} = q. \label{eq:Ii-Io}
\end{gather}
The source term is given by
\begin{gather}
  q = -I_{\fs} - \frac{\im n S_{\Omega}}{2} \sum_{k = \inw, \out} \frac{c R}{\vec{l}_{k} \cdot \nabla \psi} \left( \vec{l}_{k} \cdot \nabla p_{n} - \frac{B_{n \phi}}{B_{0 \phi}} \vec{l}_{k} \cdot \nabla p_{0} \right) + j_{0 \phi} \left( \frac{B_{n \phi}}{R B_{0 \phi}} + \frac{\vec{B}_{n}^{\pol} \cdot \vec{n}}{\vec{l}_{k} \cdot \nabla \psi} \right).
\end{gather}
The directional derivatives $\vec{l}_{k} \cdot \nabla \psi$ are approximated by a difference quotient with values taken at the nodes (for indexing see \cref{fig:grid}),
\begin{align}
  \vec{l}_{\inw} \cdot \nabla \psi = l_{\inw} \hat{\vec{l}}_{\inw} \cdot \nabla \psi = l_{\inw} \pd[\psi]{\vec{l}_{\inw}} & \approx l_{\inw} \frac{\symup{\Delta} \psi}{l_{\inw}} = \symup{\Delta} \psi, \\
  \vec{l}_{\out} \cdot \nabla \psi = l_{\out} \hat{\vec{l}}_{\out} \cdot \nabla \psi = l_{\out} \pd[\psi]{\vec{l}_{\out}} & \approx l_{\out} \frac{-\symup{\Delta} \psi}{l_{\out}} = -\symup{\Delta} \psi.
\end{align}
Note that $\psi \vert_{\vfs} \neq \psi \vert_{\vinw} = \psi \vert_{\vout}$ for each triangle because values are taken from the nodes at adjacent flux surfaces. Thus $\symup{\Delta} \psi$ is identical for the entire loop, but signs change depending on the direction of $\vec{l}_{k}$, alternating between triangles. It takes a positive value for $\vec{l}_{k}$ pointing in the radially outward direction. The same logic applies to $\vec{l} \cdot \nabla p_{0}$ terms, albeit with reversed sign because $p_{0}$ decreases radially outwards.

For the global indexing scheme, we call the ingoing current into triangle $(i)$ counted in clockwise direction $I^{(i)}$. In triangle $(i)$, this is equal to $I_{\inw} = -I^{(i)}$ and $I_{\out} = I^{(i+1)}$. The matrix form of \cref{eq:Ii-Io} is then
\begin{gather}
  A_{ij} I^{(j)} = q_{i},
\end{gather}
where the elements of the stiffness matrix $A$ are
\begin{gather}
  A_{ij} = \left( -1 + \frac{\im n S_{\Omega^{(i)}}}{2} \frac{B_{0 (\phi)} \vert_{\Gamma_{\inw}^{(i)}}}{\symup{\Delta} \psi} \right) \delta_{i j} + \left( 1 + \frac{\im n S_{\Omega^{(i)}}}{2} \frac{B_{0 (\phi)} \vert_{\Gamma_{\out}^{(i)}}}{\symup{\Delta} \psi} \right) \delta_{i+1, j}.
\end{gather}

\subsection{Test field}

We can take
\[
  B_{n}^{\phi} = B_{n}^{\psi} F(\psi)
\]
where 
\[
  F(\psi) = \frac{\im R_{0}}{n q} \pd[q]{\psi}
\]
and (reminder) the normal component has been chosen as 
\[
  B_{n}^{\psi} = \frac{B_{0 \phi} R_{0}}{R^{2}}.
\]
For derivation one uses the Jacobian of symmetry flux coordinates $(\psi, \theta, \phi)$ 
\[
  \sqrt{g} = \frac{1}{B_{0}^{\theta}} = \frac{q}{B_{0}^{\phi}} = \frac{q}{R^{2} B_{0 \phi}}.
\]

\subsection{Safety factor}

Toroidal flux is
\begin{align}
  \psi_{\tor} &= \int \diff V \, \vec{B} \cdot \nabla \phi \nonumber \\
  &= 2 \pi \int \diff R \, \diff Z \, R B^{\phi} = \int \diff R \, \diff Z \, B_{(\phi)}.
\end{align}

\subsection{Current perturbation -- alternative}

We split the current into parallel and perpendicular current:
\begin{gather}
  \vec{j}_{n} = j_{n \parallel} \vec{h}_{0} + \vec{j}_{n \perp}.
\end{gather}
We write the divergence-freeness condition as
\begin{gather}
  \nabla \cdot (\vec{h}_{0}^{\pol} j_{n \parallel}) + \im n h_{0}^{\phi} j_{n \parallel} = -\nabla \cdot \vec{j}_{n \perp}^{\pol} - \im n j_{n \perp}^{\phi}.
\end{gather}
In integral form, multiplied by $R$:
\begin{gather}
  \oint R j_{n \parallel} \vec{h}_{0}^{\pol} \cdot \vec{n} \, \diff l + \im n \int R h_{0}^{\phi} j_{n \parallel} \, \diff S = -\oint R \vec{j}_{n \perp}^{\pol} \cdot \vec{n} \, \diff l - \im n \int R j_{n \perp}^{\phi} \, \diff S.
\end{gather}
Approximate
\begin{gather}
  R^{1} j_{n \parallel}^{1} \vec{h}_{0}^{\pol} \cdot \vec{n}^{1} + R^{2} j_{n \parallel}^{2} \vec{h}_{0}^{\pol} \cdot \vec{n}^{2} + \im n S_{\Omega} \frac{(h_{0 (\phi)}^{1} j_{n \parallel}^{1} + h_{0 (\phi)}^{2} j_{n \parallel}^{2})}{2} = \nonumber \\
  -R^{1} \vec{j}_{n \perp}^{\pol, 1} \cdot \vec{n}^{1} - R^{2} \vec{j}_{n \perp}^{\pol, 2} \cdot \vec{n}^{2} - R^{3} \vec{j}_{n \perp}^{\pol, 3} \cdot \vec{n}^{3} - \im n S_{\Omega} R j_{n \perp}^{\phi}.
\end{gather}
We use
\begin{align}
  j_{n \perp}^{\phi} &= \text{TODO} - \frac{c B_{n \parallel}}{B_{0}^{2}} \nabla \phi \cdot (\vec{h}_{0} \times \nabla p_{0}) + \frac{c}{B_{0}} \nabla \phi \cdot (\vec{h}_{0} \times \nabla p_{n}) \\
  &= -\frac{c B_{n \parallel}}{B_{0}^{3}} \nabla p_{0} \cdot ((\nabla \psi \times \nabla \phi) \times \nabla \phi) + \frac{c}{B_{0}^{2}} \nabla p_{n} \cdot ((\nabla \psi \times \nabla \phi) \times \nabla \phi)\\
  &= \frac{c B_{n \parallel}}{R^{2} B_{0}^{3}} \nabla p_{0} \cdot \nabla \psi - \frac{c}{R^{2} B_{0}^{2}} \nabla p_{n}\cdot \nabla \psi \\
  &= \frac{c B_{n \parallel}}{R^{2} B_{0}^{3}} p_{0}'(\psi) \lvert \nabla \psi \rvert^{2} - \frac{c}{R^{2} B_{0}^{2}} \nabla p_{n} \cdot \nabla \psi.
\end{align}
We would like to represent
\begin{gather}
  \nabla \psi = (\nabla \psi)_{1} \vec{l}^{1} + (\nabla \psi)_{2} \vec{l}^{2}.
\end{gather}
We construct the system
\begin{align*}
  \vec{l}^{1} \cdot \nabla \psi &= \lvert l^{1} \rvert^{2} (\nabla \psi)_{1} + \vec{l}^{1} \cdot \vec{l}^{2} (\nabla \psi)_{2} \\
  \vec{l}^{2} \cdot \nabla \psi = -(\vec{l}^{1} \cdot \nabla \psi) &= \vec{l}^{1} \cdot \vec{l}^{2} (\nabla \psi)_{1} + \lvert l^{2} \rvert^{2} (\nabla \psi)_{2}
\end{align*}
or generally
\begin{align*}
  v_{1} &= \frac{\lvert l^{2} \rvert^{2} + (\vec{l}^{1} \cdot \vec{l}^{2})}{\lvert l^{1} \rvert^{2} \lvert l^{2} \rvert^{2} - (\vec{l}^{1} \cdot \vec{l}^{2})^{2}} (\vec{l}^{1} \cdot \vec{v}) \\
  v_{2} &= \frac{\lvert l^{1} \rvert^{2} + (\vec{l}^{1} \cdot \vec{l}^{2})}{\lvert l^{1} \rvert^{2} \lvert l^{2} \rvert^{2} - (\vec{l}^{1} \cdot \vec{l}^{2})^{2}} (\vec{l}^{2} \cdot \vec{v}).
\end{align*}
Finally
\begin{align}
  \vec{v} &= \frac{\lvert l^{2} \rvert^{2} + (\vec{l}^{1} \cdot \vec{l}^{2})}{\lvert l^{1} \rvert^{2} \lvert l^{2} \rvert^{2} - (\vec{l}^{1} \cdot \vec{l}^{2})^{2}}(\vec{l}^{1} \cdot \vec{v}) \vec{l}^{1} + \frac{\lvert l^{1} \rvert^{2} + (\vec{l}^{1} \cdot \vec{l}^{2})}{\lvert l^{1} \rvert^{2} \lvert l^{2} \rvert^{2} - (\vec{l}^{1} \cdot \vec{l}^{2})^{2}}(\vec{l}^{2} \cdot \vec{v}) \vec{l}^{2} \\
  &= c_{1} (\vec{l}^{1} \cdot \vec{v}) \vec{l}^{1} + c_{2} (\vec{l}^{2} \cdot \vec{v}) \vec{l}^{2}.
\end{align}
Flux
\begin{align}
  B_{n \parallel} &= \vec{B}_{n} \cdot \vec{h} = \vec{B}_{n}^{\pol} \cdot \vec{h}^{\pol} + B_{n \phi} h^{\phi} \nonumber \\
  &= c_{1} (\vec{n}^{1} \cdot \vec{B}_{n}^{\pol}) \vec{n}^{1} \cdot \vec{h}^{\pol} + c_{2} (\vec{n}^{2} \cdot \vec{B}_{n}^{\pol}) \vec{n}^{2} \cdot \vec{h}^{\pol} + B_{n (\phi)} h_{(\phi)}.
\end{align}

\appendix
\section{Overview of used vector quantities}
\begin{gather*}
  \nabla \psi \parallel \nabla p_0 \parallel \vec{n}_3 \\
  \nabla \phi \perp \left( \nabla \psi, \dotsc, \vec{l}_3, \vec{B}_{\bullet}^{\pol}, \vec{h}_{0}^{\pol}, \vec{j}_{\bullet}^{\pol}, \nabla p_n \right)
\end{gather*}

\end{document}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% eval: (TeX-source-correlate-mode)
%%% eval: (TeX-PDF-mode t)
%%% eval: (TeX-engine (quote luatex))
%%% End: 
