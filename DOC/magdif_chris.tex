%% LyX 2.2.3 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[12pt,british,english]{article}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{geometry}
\geometry{verbose,tmargin=2cm,bmargin=2cm,lmargin=2cm,rmargin=2cm}
\usepackage{amsmath}

\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% User specified LaTeX commands.
\usepackage{tikz}

\makeatother

\usepackage{babel}
\begin{document}
\selectlanguage{british}%
\global\long\def\tht{\vartheta}
\global\long\def\ph{\varphi}
\global\long\def\balpha{\boldsymbol{\alpha}}
\global\long\def\btheta{\boldsymbol{\theta}}
\global\long\def\bJ{\boldsymbol{J}}
\global\long\def\bGamma{\boldsymbol{\Gamma}}
\global\long\def\bOmega{\boldsymbol{\Omega}}
\global\long\def\d{\text{d}}
\global\long\def\t#1{\text{#1}}
\global\long\def\m{\text{m}}
\global\long\def\bm{\text{\textbf{m}}}
\global\long\def\k{\text{k}}
\global\long\def\i{\text{i}}
\global\long\def\v#1{\boldsymbol{#1}}
\selectlanguage{english}%

\title{Magnetic differential equations for stationary linear ideal MHD and
their numerical solution}

\title{\textemdash{} remaining input from Chris}
\maketitle

\subsection*{Coordinate conventions}

We use two different right-handed coordinate systems: Firstly cylindrical
coordinates $(R,\ph,Z)$ with $\ph$ running counterclockwise as seen
from above, so
\begin{align*}
x & =R\cos\ph,\quad y=R\sin\ph,\quad z=Z.
\end{align*}
Those coordinates are used in computations and for meshes. For derivations,
also symmetry flux coordinates $(\rho,\theta,\zeta)$ are used at
some point. Here, we use the convention of d'Haeseleer with radial
coordinate growing towards the outside of the torus. As a radial variable
we use $\rho=\sigma_{\mathrm{pol}}\psi$ with $\sigma_{\mathrm{pol}}=+1$
for counterclockwise poloidal field $\v B_{0}^{\mathrm{pol}}$ and
$\sigma_{\mathrm{pol}}=-1$ for clockwise field. The toroidal symmetry
angle is defined in the direction opposite to $\ph$ with
\begin{align*}
\zeta & =\frac{\pi}{2}-\ph.
\end{align*}
The flux angle $\theta$ has the same orientation as $\vartheta=\arctan\frac{Z}{R}$,
so the sign $\sigma_{\mathrm{pol}}=\mathrm{sgn}(B^{\tht})=\mathrm{sgn}(B^{\theta})$
is positive for counter-clockwise and negative for clockwise orientation
in the poloidal plane. The Jacobian of symmetry flux coordinates $(\rho,\theta,\zeta)=(\sigma_{\mathrm{pol}}\psi,\theta,\frac{\pi}{2}-\varphi)$
is
\begin{align}
\sqrt{g} & =\frac{\sigma_{\mathrm{pol}}}{B_{0}^{\vartheta}}=\sigma_{\mathrm{pol}}\frac{q}{B_{0}^{\zeta}}\\
 & =-\sigma_{\mathrm{pol}}\frac{q}{B_{0}^{\varphi}}=-\sigma_{\mathrm{pol}}\frac{qR^{2}}{B_{0\varphi}}.
\end{align}
If $B_{0}^{\tht}$ changes sign, both, $\sigma_{\mathrm{pol}}$ and
$q$ change sign, and a sign change in $B_{0}^{\ph}$ leads to a sign
change also in $q$. Thus, $\sqrt{g}$ is always positive. The sign
of $q$ describes the sign of the helicity in $(\tht,\zeta)$ and
can be computed as described below. Note that in our configuration
(ASDEX Upgrade) $\sigma_{\mathrm{pol}}=-1$ and $B_{0\varphi}$ is
positive, so $q$ is negative. 

\subsection*{Safety factor}

With the usual toroidal flux angle $\zeta=\pi/2-\ph$ (d'Haeseleer),
the toroidal flux $\psi_{\text{tor}}$ is given by
\begin{align}
\psi_{\text{tor}} & =\frac{1}{(2\pi)^{2}}\int\d V\,\boldsymbol{B}\cdot\nabla\zeta=-\frac{1}{(2\pi)^{2}}\int\d V\,\boldsymbol{B}\cdot\nabla\ph\nonumber \\
 & =-\frac{1}{2\pi}\int\d R\d Z\,RB^{\ph}=-\frac{1}{2\pi}\int\d R\d ZB_{(\ph)}.
\end{align}
The safety factor is then given by
\begin{align*}
q & =\frac{\psi_{\mathrm{tor}}^{\prime}(\rho)}{\psi_{\mathrm{pol}}^{\prime}(\rho)}=\frac{\psi_{\mathrm{tor}}^{\prime}(\sigma_{\mathrm{pol}}\psi)}{\psi_{\mathrm{pol}}^{\prime}(\sigma_{\mathrm{pol}}\psi)}=\frac{\d\psi_{\mathrm{tor}}}{\d\psi}\\
 & =-\frac{1}{2\pi}\frac{\d}{\d\psi}\int\d R\d ZB_{(\ph)}.
\end{align*}
This quantity can be evaluated numerically by adding up $B_{(\ph)}$
inside the volume between two flux surfaces and dividing by the the
difference in $\psi$:
\begin{align*}
q & \approx-\frac{1}{2\pi\Delta\psi}\sum_{\triangle}B_{(\ph)}S_{\triangle}
\end{align*}
where the sum is taken over all triangles inside a triangle strip,
and $S_{\Delta}$ is the respective triangle surface area.

\subsection*{Generating a non-resonant test field}

The axisymmetric equilibrium field $\v B_{0}$ lies on nested flux
surfaces $\psi=\mathrm{const.}$ meaning
\[
\v B_{0}\cdot\nabla\psi=0.
\]
If the perturbed field shall still lie on distorted, but not broken,
flux surfaces (without magnetic islands), a new flux surface label
$\psi+\delta\psi$ must exist fulfilling

\[
(\v B_{0}+\delta\v B)\cdot\nabla(\psi+\delta\psi)=0
\]
for the perturbed magnetic field $\v B_{0}+\delta\v B$, where $\delta\psi$
remains small and continuous within the plasma. In that case we can
use a linear order expansion
\[
\underbrace{\v B_{0}\cdot\nabla\psi}_{=0}+\v B_{0}\cdot\nabla\delta\psi+\delta\v B\cdot\nabla\psi+\mathcal{O}(\varepsilon^{2})=0,
\]
or in coordinate form with symmetry flux coordinates $(\rho,\tht,\zeta)$,
\[
B_{0}^{\tht}\frac{\partial\delta\psi}{\partial\tht}+B_{0}^{\zeta}\frac{\partial\delta\psi}{\delta\zeta}+\delta B^{\rho}=0.
\]
With safety factor $q$ defined for clockwise toroidal direction $\d\zeta=-\d\ph$
(see above) we obtain
\begin{align*}
\left(\frac{\partial}{\partial\tht}-q\frac{\partial}{\partial\ph}\right)\delta\psi & =-\sigma_{\mathrm{pol}}\frac{\delta B^{\psi}}{B_{0}^{\tht}}\\
 & =-\sigma_{\mathrm{pol}}\frac{\sqrt{g}\delta B^{\psi}}{\psi_{\mathrm{tor}}^{\prime}(\rho)}=-\sigma_{\mathrm{pol}}\frac{\sqrt{g}\delta B^{\psi}}{\sigma_{\mathrm{pol}}\psi_{\mathrm{tor}}^{\prime}(\psi)}\\
 & =-\frac{\sqrt{g}\delta B^{\psi}}{q}.
\end{align*}
Written in terms of toroidal Fourier harmonics $m,n$ in $\tht,\ph$
the equation becomes
\begin{align*}
\psi_{mn} & =-\frac{\left(\sqrt{g}\delta B^{\psi}\right)_{mn}}{q\left(m-nq\right)}=-\frac{\left(\sqrt{g}B_{n}^{\psi}\right)_{m}}{q\left(m-nq\right)}.
\end{align*}
The safety factor $q$ is a flux function, but $\sqrt{g}$ depends
also on $\tht$, so poloidal harmonics $m$ have to be taken outside
the bracket here. In order to fulfill the original requirement not
to break flux surfaces, $\psi_{mn}$ must never diverge, so $(m-nq)$
must not become zero. We can avoid such resonant surfaces if $\left(\sqrt{g}B_{n}^{\psi}\right)_{m}=0$
for all possible $m$ that could lead to a resonance. The simplest
way to do so is to make $\sqrt{g}B_{n}^{\psi}$ a flux function, possessing
only the poloidally symmetric harmonic $m=0$. More generally, also
$m<nq_{\mathrm{min}}$ and $m>nq_{\mathrm{max}}$ are possible, but
for nonzeri $m$ a transformation to the flux angle $\tht$ has to
be computed explicitly.

Using the Jacobian of symmetry flux coordinates we obtain
\begin{align*}
\psi_{mn} & =\frac{\sigma_{\mathrm{pol}}}{m-nq}\left(\frac{R^{2}}{B_{0\varphi}}B_{n}^{\psi}\right)_{m},
\end{align*}
so, to generate a non-resonant field, we are allowed to use any value
$B_{n}^{\psi}=C(\psi)B_{0\ph}/R^{2}$, where $C(\psi)$ is a flux
function. The other components of $\delta\v B$ are not relevant for
the resonance condition and just need to fulfill divergence-freeness.

\subsection*{Generating a non-resonant test field (old, doesn't work with purely
radial)}

We would like to have a completely non-resonant and only radial field
\begin{align*}
\delta\v B & =\v B_{n}e^{in\ph}
\end{align*}
 with $B_{n}^{\ph}=B_{n}^{\tht}=0$. As an ansatz we take as a radial
component of the field
\begin{equation}
B_{n}^{\psi}=\frac{B_{0\varphi}R_{0}}{qR^{2}}=-\frac{R_{0}}{\sqrt{g}}.
\end{equation}
Divergence-freeness of $\delta\boldsymbol{B}$ is now possible for
a field containing only the radial component $\delta B^{\rho}=\sigma_{\mathrm{pol}}\delta B^{\psi}$
with
\begin{align*}
\nabla\cdot\delta\v B & =\frac{1}{\sqrt{g}}\frac{\partial}{\partial x^{k}}\left(\sqrt{g}\delta B^{k}\right)\\
 & =\frac{1}{\sqrt{g}}\frac{\partial}{\partial x^{k}}\left(\sqrt{g}\delta B^{\rho}\right)\\
 & =\frac{1}{\sqrt{g}}\frac{\partial}{\partial x^{k}}\left(-\sigma_{\mathrm{pol}}R_{0}\right)=0.
\end{align*}
This means that
\begin{align*}
\v B_{n} & =(\v B_{n}\cdot\nabla\psi)\v e_{\psi}=B_{n}^{\psi}\v e_{\psi}.
\end{align*}
Fluxes through edges are
\begin{align*}
\Psi & \approx R\v B_{n}\cdot\v n\\
 & =RB_{n}^{\psi}(\v e_{\psi}\cdot\v n)\\
 & =RB_{n}^{\psi}n_{\psi}
\end{align*}
Fluxes through edges parallel to flux surfaces with $\v n_{3}=\sigma l_{3}\nabla\psi/|\nabla\psi|$
are
\begin{align*}
\Psi_{3} & \approx R_{3}B_{n}^{\psi}\v e_{\psi}\cdot\v n_{3}\\
 & =\sigma l_{3}R_{3}B_{n}^{\psi}/|\nabla\psi|\\
 & =R_{3}l_{3}\frac{B_{n}^{\psi}}{|\nabla\psi|^{2}}(\hat{\v n}_{3}\cdot\nabla\psi)\\
 & =R_{3}\frac{B_{n}^{\psi}}{|\nabla\psi|^{2}}(\v n_{3}\cdot\nabla\psi).
\end{align*}
TODO: other edges either by conservation law or by vector projection.

\subsection*{Reading input files from experiment}
\begin{itemize}
\item ASDEX Upgrade has two formats that are common: CLISTE and EFIT/EQDSK
(g-files)
\item Much data in /proj/plasma/RMP/DATA/ASDEX/ and /proj/plasma/RMP/DATA2017/ASDEX/
\end{itemize}

\subsection*{Reduced MHD (unfinished)}

We take
\[
B_{n\ph}=0
\]
so
\begin{align*}
\boldsymbol{B}_{n} & =\nabla\psi_{n}\times\nabla\ph.
\end{align*}
Amperes law becomes
\begin{align*}
\nabla\times\boldsymbol{B}_{n} & =\frac{1}{4\pi}\boldsymbol{J}_{n}.
\end{align*}

\end{document}
