\section{Numerical Treatment of the Magnetic Field Perturbation}
\label{sec:compute_Bn}

In this chapter, the calculation of the magnetic field from the current density is described, i.e. the explicit form of $\hat{M}$ in \cref{eq:M_operator}. The implementation uses \texttt{FreeFem++} by \textcite{Hecht12}, while the mathematical background is outlined in \cref{sec:ritz-galerkin}, which is based on the book by \textcite{Jin02}. For a more specific discussion and thorough derivations for the problem at hand, see \textcite{Seeber18}. Finally, the application of the \textsc{Fourier} transform is elaborated in \cref{sec:fourier-fem}, based on the papers by \textcite{Heyn08,Albert16}.

The finite element method can be used to numerically solve partial differential equations, specifically boundary value problems. Before delving into the details of the method, we shall look at how this applies to \cref{eq:ampere}. Using an identity from vector analysis, we get
\begin{gather}
  \curl (\curl \vec{A}) = \grad (\divg \vec{A}) - (\nabla \cdot \nabla) \vec{A} = \frac{4 \pi}{c} \vec{J}. \label{eq:ampere-laplacian}
\end{gather}
Without loss of generality, we use the \textsc{Coulomb} gauge with
\begin{gather}
  \divg \vec{A} = 0
\end{gather}
and \cref{eq:ampere-laplacian} reduces to
\begin{gather}
  (\nabla \cdot \nabla) \vec{A} =: \symup{\Delta} \vec{A} = -\frac{4 \pi}{c} \vec{J},
\end{gather}
where $\symup{\Delta}$ is the Laplacian. For vector arguments, the latter only takes on a simple form for Cartesian coordinates:
\begin{gather}
  \left ( \frac{\partial^{2}}{\partial x^{2}} + \frac{\partial^{2}}{\partial y^{2}} + \frac{\partial^{2}}{\partial z^{2}} \right ) A_{k} = -\frac{4 \pi}{c} J_{k} \quad \forall k = x, y, z.
\end{gather}
Thus the differential equation for the Cartesian components of the magnetic vector potential is of the \textsc{Poisson} type,
\begin{gather}
  \symup{\Delta} \Phi = f.
\end{gather}
This is an elliptical partial differential equation of second order, so the solution shall be twice continuously differentiable on the given domain, i.e. $\Phi \in C^{2} (\Omega)$. For this type of PDE, a unique solution exists when one of the following boundary conditions is imposed on the boundary $\Gamma = \partial \Omega$.
\begin{itemize}
\item A \textsc{Dirichlet} boundary condition imposes functional values on the boundary:
  \begin{gather*}
    \Phi (\vec{r}) = \gamma_{\text{D}} (\vec{r}) \quad \forall \vec{r} \in \Gamma.
  \end{gather*}
\item A \textsc{Neumann} boundary condition imposes normal derivatives on the boundary:
  \begin{gather*}
    \grad \Phi (\vec{r}) \cdot \vec{n} (\vec{r}) = \gamma_{\text{N}} (\vec{r}) \quad \forall \vec{r} \in \Gamma.
  \end{gather*}
  There is an additional compatibility condition that has to be satisfied by the inhomogeneities of \textsc{Poisson}'s equation and the boundary condition:
  \begin{gather*}
    \oint_{\Gamma} \gamma_{\text{N}} (\vec{r}) \, \diff \Gamma = \int_{\Omega} f (\vec{r}) \, \diff \Omega.
  \end{gather*}
\item A \textsc{Robin} boundary condition imposes a weigehted sum of \textsc{Dirichlet} and \textsc{Neumann} boundary conditions:
  \begin{gather*}
    C_{\text{D}} \Phi (\vec{r}) + C_{N} \grad \Phi (\vec{r}) \cdot \vec{n} (\vec{r}) = \gamma_{\text{R}} (\vec{r}) \quad \forall \vec{r} \in \Gamma.
  \end{gather*}
  This has to be distinguished from a \textsc{Cauchy} boundary condition where \textsc{Dirichlet} and \textsc{Neumann} boundary conditions are imposed on the same point independently of each other. For elliptical PDEs, this usually is not a well-posed problem and may lead to an overdetermined set of equations.
\item Mixed boundary conditions are enforced when any of the above is imposed on each piece of the boundary, e.g. \textsc{Dirichlet} boundary conditions on $\Gamma_{\text{D}}$ and \textsc{Neumann} boundary conditions on $\Gamma_{\text{N}}$. In the latter example, it is necessary that
  \begin{gather*}
    \Gamma_{\text{N}} \cup \Gamma_{\text{D}} = \Gamma, \quad \Gamma_{\text{N}} \cap \Gamma_{\text{D}} = \emptyset
  \end{gather*}
  holds to avoid the aforementioned problem with \textsc{Cauchy} boundary conditions.
\end{itemize}
Even though we applied this categorization to Cartesian components, it holds in any coordinate system since a simple geometrical coordinate transform does not change the type of the PDE and thus the finite element method is applicable. It should be noted, however, that we can not prescribe all vector components at the same time; according to \textcite{Biro15}, the normal and tangential components have to be separated. For the normal components, we can prescribe the magnetic surface charge density $b$,
\begin{gather}
  \vec{B} \cdot \vec{n} = -b, \label{eq:perp_bc}
\end{gather}
which has to fulfill the additional condition that
\begin{gather*}
  \oint_{\Gamma} b \, \symup{d} \Gamma = -\oint_{\Gamma} \symbf{B} \cdot \symbf{n} \, \symup{d} \Gamma = -\int_{\Omega} \nabla \cdot \symbf{B} \, \symup{d} \Omega = 0.
\end{gather*}
For the tangential component, the magnetic surface current density $\vec{K}$ can be prescribed,
\begin{gather}
  \vec{B} \times \vec{n} = \frac{4 \pi}{c} \vec{K}, \label{eq:par_bc}
\end{gather}
which has to fulfill the additional condition that
\begin{gather*}
  \frac{4 \pi}{c} \oint_{\Gamma} \vec{K} \, \symup{d} \Gamma = \oint_{\Gamma} \vec{B} \times \vec{n} \, \symup{d} \Gamma = -\int_{\Omega} \curl \vec{B} \, \symup{d} \Omega = -\frac{4 \pi}{c} \int_{\Omega} \vec{J} \, \symup{d} \Omega.
\end{gather*}
When deriving the weak formulation in the following section, these two options will be assigned to their corresponding boundary conditions.

\subsection{Outline of the Ritz and Galerkin Methods}
\label{sec:ritz-galerkin}

The finite element method is used to solve problems of the general form
\begin{gather}
  \symcal{L} \Phi = f, \label{eq:fem}
\end{gather}
where $\Phi$ and $f$ are arbitrary functions and $\symcal{L}$ is a differential operator. For the \textsc{Ritz} method, $\symcal{L}$ is assumed to be a real differential operator that is self-adjoint and positive definite, i.e.
\begin{align}
  \langle \symcal{L} u, v \rangle &= \langle u, \symcal{L} v \rangle, \label{eq:self-adjoint} \\
  \langle \symcal{L} u, u \rangle & \begin{cases}
    > 0 & u \neq 0, \\
    = 0 & u = 0
  \end{cases} \label{eq:positive_definite}
\end{align}
in regard to a scalar product defined by
\begin{gather}
  \langle u, v \rangle = \int_{\Omega} u v^{*} \, \symup{d} \Omega. \label{eq:scalar_prod}
\end{gather}
The solution of the differential equation corresponds to the minimum of the functional
\begin{gather}
  F(\Phi) = \tfrac{1}{2} \langle \symcal{L} \Phi, \Phi \rangle - \tfrac{1}{2} \langle \Phi, f \rangle - \tfrac{1}{2} \langle f, \Phi \rangle, \label{eq:variational}
\end{gather}
i.e. $\delta F = 0$ and $\delta (\delta F) > 0$, where $\delta F$ is the variation. Now, the problem is discretized by projecting $\Phi$ into a finite subspace of the full solution space, i.e. it is approximated by
\begin{gather}
  \tilde{\Phi} = \sum_{k = 1}^{N} C_{k} v_{k} = \vec{C} \cdot \vec{v},
\end{gather}
where $C_{k}$ are constant expansion coefficients or \emph{degrees of freedom} and $v_{k}$ are \emph{basis functions} which will be defined later. Now, the variational form in \cref{eq:variational} can be cast into an algebraic form,
\begin{gather}
  \pd{C_{k}} F(\tilde{\Phi}) = 0 \quad \forall k = 1, 2, \dotsc, N.
\end{gather}
This results in a system of $N$ linear equations of $N$ unknowns,
\begin{gather}
  \hat{K} \vec{C} = \vec{s}. \label{eq:ritz}
\end{gather}
Here, $\hat{K}$ is the \emph{stiffness matrix}\footnote{\label{fn:zienkiewicz}These quantities derive their names from the application of the method to problems of solid mechanics in civil engineering.} given by
\begin{gather}
  K_{jk} = \frac{1}{2} \int_{\Omega} v_{j} \symcal{L} v_{k} + v_{k} \symcal{L} v_{j} \, \symup{d} \Omega = \int_{\Omega} v_{j} \symcal{L} v_{k} \, \symup{d} \Omega \quad \forall j, k = 1, 2, \dotsc, N,
\end{gather}
where we used \cref{eq:self-adjoint} in the last equality. The \emph{load vector}\footref{fn:zienkiewicz} $\vec{s}$ is given by
\begin{gather}
  s_{k} = \int_{\Omega} v_{k} f \, \symup{d} \Omega \quad \forall k = 1, 2, \dotsc, N.
\end{gather}
Now, describing the whole domain $\Omega$ by a limited set of basis functions $\vec{v}$ would entail the construction of complicated basis function to cover the whole domain. Instead, we discretize the computational domain into the eponymous \emph{finite elements}, which we already discussed in \cref{sec:grid}. The basis functions are then defined to extend only over one element and to be zero on all others. This allows a reasonable approximation of almost arbitrary functions by simple polynomial basis functions over arbitrary domains. \Cref{eq:ritz} is then defined for each of the $M$ finite elements, yielding a set of $M N$ linear equations in $M N$ unknowns. Since only a few neighboring finite elements are connected, $\hat{K}$ then takes the shape of a band matrix, for which efficient numerical solutions are available.

The conventional \textsc{Ritz} method also has its shortcomings. When $\symcal{L}$ is not self-adjoint or positive definite, the \textsc{Ritz} method has to be modified. For example, complex $\symcal{L}$ are not self-adjoint with the scalar product defined in \cref{eq:scalar_prod}. Furthermore, if inhomogeneous boundary conditions are applied, the functional $F$ has to be extended by a function that fulfills this boundary condition. For all these generalized cases, the \textsc{Galerkin} method may be used instead, which also does not require the construction of a variational form. Observing that $\tilde{\Phi}$ is only an approximation to $\Phi$, inserting the former into the original differential \cref{eq:fem} will leave a residue, i.e.
\begin{gather}
  \symcal{L} \tilde{\Phi} - f \neq 0.
\end{gather}
Now, another approach to approximate the minimum of the functional $F$ is to minimize the residues $r_{k}$ with regard to weighting functions $w_{k}$,
\begin{gather}
  r_{k} = \int_{\Omega} w_{k} \underbrace{(\symcal{L} \tilde{\Phi} - f)}_{\neq 0} \, \symup{d} \Omega.
\end{gather}
For the \textsc{Galerkin} method, the weighting functions $w_{k}$ are the same as the basis functions $v_{k}$. This approach also results in a system of $N$ linear equations of $N$ unknowns, as in \cref{eq:ritz}. Here, $\hat{K}$ is only symmetric if $\symcal{L}$ is self-adjoint, in which case the equations are the same as with the \textsc{Ritz} method.

The weighting functions $w_{k}$ are also called \emph{test functions} in the context of the \emph{weak formulation} of the differential equation, where they are used to apply integration by parts or analogs thereof, such as \textsc{Green}'s identities or the divergence theorem. This allows the enforcement of the boundary conditions since integrals on the boundary will appear. As an illustration, we shall derive the weak formulation of \cref{eq:ampere} based on the treatment by \textcite{Biro15}. To this end, we take a dot product of \cref{eq:ampere} with a vectorial test function $\vec{w}$, integrate over $\Omega$, and apply the divergence theorem:
\begin{align}
  \int_{\Omega} \vec{w} \cdot (\curl (\curl \vec{A})) \, \symup{d} \Omega &= \frac{4 \pi}{c} \int_{\Omega} \vec{w} \cdot \vec{J} \, \symup{d} \Omega, \notag \\
  \int_{\Omega} (\curl \vec{w}) \cdot (\curl \vec{A}) \, \symup{d} \Omega - \int_{\Omega} \nabla \cdot (\vec{w} \times (\curl \vec{A})) \, \symup{d} \Omega &= \frac{4 \pi}{c} \int_{\Omega} \vec{w} \cdot \vec{J} \, \symup{d} \Omega, \notag \\
  \int_{\Omega} (\curl \vec{w}) \cdot (\curl \vec{A}) \, \symup{d} \Omega - \oint_{\Gamma} (\vec{w} \times (\curl \vec{A})) \cdot \vec{n} \, \symup{d} \Gamma &= \frac{4 \pi}{c} \int_{\Omega} \vec{w} \cdot \vec{J} \, \symup{d} \Omega, \notag \\
  \int_{\Omega} (\curl \vec{w}) \cdot (\curl \vec{A}) \, \symup{d} \Omega - \oint_{\Gamma} \vec{w} \cdot ((\curl \vec{A}) \times \vec{n}) \, \symup{d} \Gamma &= \frac{4 \pi}{c} \int_{\Omega} \vec{w} \cdot \vec{J} \, \symup{d} \Omega. \label{eq:weak-form}
\end{align}
The second integral on the left-hand side shows that a \textsc{Neumann} boundary condition of the form
\begin{gather}
  (\curl \vec{A}) \times \vec{n} = \frac{4 \pi}{c} \vec{K}, \label{eq:natural_bc}
\end{gather}
corresponding to the tangential component in \cref{eq:par_bc}, appears as a \emph{natural boundary condition} of the weak form. \Cref{eq:natural_bc} can be used to replace the expression in the weak formulation to impose the boundary condition. For the \textsc{Dirichlet} boundary condition, we make the connection to \cref{eq:perp_bc} via
\begin{align}
  \vec{A} \times \vec{n} &= \vec{\alpha}, \label{eq:essential_bc} \\
  \nabla \cdot (\vec{A} \times \vec{n}) &= \nabla \cdot \vec{\alpha} = -b, \notag \\
  \vec{n} \cdot (\curl \vec{A}) - \vec{A} \cdot \underbrace{(\curl \vec{n})}_{\vec{0}} &= -b, \notag \\
  \vec{n} \cdot (\curl \vec{A}) = \vec{B} \cdot \vec{n} &= -b, \notag
\end{align}
where $\vec{\alpha}$ is an auxiliary function also depending on the gauge of $\vec{A}$. Since it cannot be connected to the weak formulation in \cref{eq:weak-form}, \cref{eq:essential_bc} is an \emph{essential boundary condition}; it poses direct restrictions on the degrees of freedom at the boundary elements in the form $C_{j} = \alpha_{j}$ (see \cref{eq:ritz}) for all affected $j$. By setting
\begin{align}
  K_{jk} &= \delta_{jk} \quad \forall k = 1, 2, \dotsc, M N, \\
  s_{j} &= \alpha_{j}, \\
  s_{k} &\to s_{k} - K_{kj} \quad \forall k \neq j,
\end{align}
we ensure $K_{kj} = \delta_{kj}$ and thus $\hat{K}$ stays symmetric. Now, the $j$th row and column can be omitted without changing the solution, reducing the dimension of the system of equations. A less sophisticated alternative is the \emph{penalty method}, where we employ a sufficiently large value $h$ and set
\begin{align}
  K_{jj} &= h, \\
  s_{j} &= h \alpha_{j}.
\end{align}
This approximates the boundary condition \cref{eq:essential_bc} and also leaves $\hat{K}$ symmetric.

Finally, we have to choose appropriate basis functions which approximate the underlying solution space. While we initially demanded that the solution be twice continuously differentiable, i.e., $A_{k} \in C^{2} (\Omega)$, the weak formulation suggests this is not strictly necessary. The integration by parts -- or equivalently the divergence theorem used in \cref{eq:weak-form} -- gives rise to the notion of the \emph{weak derivative}. Applied to \cref{eq:weak-form}, this means that there can be a valid solution with $\curl \vec{A}$ even when $\curl (\curl \vec{A})$ only exists in the weak sense that the application of the divergence theorem is valid and the integral exists. Thus also \emph{weak solutions} are allowed, and the underlying solution space is a \textsc{Sobolev} space. For our problem, the relevant \textsc{Sobolev} spaces are defined in relation to the $L^{2}$ norm
\begin{gather}
  \norm{w}_{2} = \sqrt{\int_{\Omega} \lvert w \rvert^{2} \, \diff \Omega}, \label{eq:L2-norm}
\end{gather}
so that they are at least square-integrable:
\begin{gather}
  L^{2} (\Omega) = \{ w : \Omega \to \mathbb{C} \; \vert \; \norm{w}_{2} < \infty \}.
\end{gather}
Now the \textsc{Sobolev} space $H^{1} (\Omega)$ consists of functions whose first derivatives along all coordinates $u_{k}$ are also square-integrable:
\begin{gather}
  H^{1} (\Omega) = \{ w \in L^{2} (\Omega) \; \vert \; \pd{u^{k}} w \in L^{2} (\Omega) \}.
\end{gather}
This is the appropriate function space for scalar functions whose gradient appears in the weak formulation. They are approximated by \textsc{Lagrange} elements whose degrees of freedom of lowest order are the values on nodes of the finite elements. An example would be the pressure $p$, if it were to appear in the weak formulation. Another important \textsc{Sobolev} space is $H (\Divg, \Omega)$ which is defined for vector-valued functions $\vec{w}$ as
\begin{gather}
  H (\Divg, \Omega) = \{ w_{i} \in L^{2} (\Omega) \; \vert \; \divg \vec{w} \in L^2 (\Omega) \}.
\end{gather}
Whenever we need the divergence of a vector field, e.g., for $\vec{J}$ and $\vec{B}$, this is the appropriate function space to consider. It is approximated by \textsc{Raviart}--\textsc{Thomas} elements with vector-valued basis functions and the perpendicular component of edges as degrees of freedom for lowest-order elements. This means that the perpendicular component is continuous across edges, which is important for the application of the divergence theorem. On the other hand, the parallel component on edges might be discontinuous across elements. While we have introduced these two function spaces and basis functions already in \cref{sec:grid}, we still need a function space for $\vec{A}$ with a well-defined curl. $H (\Curl, \Omega)$ is defined accordingly:
\begin{gather}
  H (\Curl, \Omega) = \{ w_{i} \in L^{2} (\Omega) \; \vert \; (\curl \vec{w})^{u_{k}} \in L^2 (\Omega) \}.
\end{gather}
The associated basis functions are the \textsc{Nédélec} elements. Like the \textsc{Raviart}--\textsc{Thomas} elements, they use vectorial basis function, but the degrees of freedom are the parallel components along edges, which is necessary for the application of \textsc{Stokes}' theorem. The continuity conditions are also reversed compared to \textsc{Raviart}--\textsc{Thomas} elements, i.e., parallel components are continuous across edges, but the perpendicular components might be discontinuous. Finally, another useful property of these function spaces is the \textsc{de Rham} complex, which shows the relation between these function spaces and the differential operators mediating between them. We can write it concisely as
\begin{gather}
  H^{1} (\Omega) \xrightarrow{\Grad} H (\Curl, \Omega) \xrightarrow{\Curl} H (\Divg, \Omega) \xrightarrow{\Divg} L^{2} (\Omega).
\end{gather}
The interpretation is as follows: Applying the curl to a function from $H (\Curl, \Omega)$ yields a result in $H (\Divg, \Omega)$. Thus when we take the curl of $\vec{A} \in H (\Curl, \Omega)$, the result $\vec{B} \in H (\Divg, \Omega)$ meets our demand of a well-defined divergence.

\subsection{Reduction to two dimensions}
\label{sec:fourier-fem}

As a further simplification, we want to apply the poloidal-toroidal decomposition discussed in \cref{sec:geom}. In the appendix of their paper, \textcite{Heyn08} describe the basics of the procedure. $\vec{A} (R, \phi, Z)$ is split into an axisymmetric part $\bar{\vec{A}} (R, Z)$ and an non-axisymmetric part $\tilde{\vec{A}} (R, \phi, Z)$. When we apply the \textsc{Fourier} transform to the latter, there is no contribution from the mode $n = 0$ by definition. Following that, we gauge $\tilde{\vec{A}}$ so that $\tilde{A}_{\phi} = 0$, which is accomplished by the transformation
\begin{gather}
  \tilde{\vec{A}} \to \tilde{\vec{A}} - \grad \int_{\phi_{\min}}^{\phi} \tilde{A}_{\phi} \, \diff \phi',
\end{gather}
which reduces to
\begin{gather}
  \tilde{\vec{A}} \to \tilde{\vec{A}} - \frac{\grad \tilde{A}_{n \phi}}{\im n}
\end{gather}
since we only consider a single harmonic $n \neq 0$. The magnetic field perturbation $\vec{B}_{n}$ is then given as
\begin{align}
  B_{n}^{R} &= \frac{\im n}{R} A_{n Z}, & B_{n}^{\phi} &= \frac{1}{R} \left ( \pd[A_{n R}]{Z} - \pd[A_{n Z}]{R} \right ), & B_{n}^{Z} &= -\frac{\im n}{R} A_{n R}.
\end{align}
This reduces the problem to the poloidal plane and we only need to solve
\begin{align}
  -R \pd{Z} \left ( \pd[A_{n R}]{Z} - \pd[A_{n Z}]{R} \right ) + \frac{n^{2}}{R} A_{n R} &= \frac{4 \pi}{c} R J_{n}^{R}, \\
  R \pd{R} \left ( \pd[A_{n R}]{Z} - \pd[A_{n Z}]{R} \right ) + \frac{n^{2}}{R} A_{n Z} &= \frac{4 \pi}{c} R J_{n}^{Z}.
\end{align}
Integration by parts in coordinate space yields the weak formulation as
\begin{multline}
  \int_{\Omega} R \left ( \pd[A_{n R}]{Z} - \pd[A_{n Z}]{R} \right ) \left ( \pd[w_{R}]{Z} - \pd[w_{Z}]{R} \right ) + \frac{n^{2}}{R} (A_{n R} w_{R} + A_{n Z} w_{Z}) \, \diff R \, \diff Z = \\ = \frac{4 \pi}{c} \int_{\Omega} R (J_{n}^{R} w_{R} + J_{n}^{Z} w_{Z}) \, \diff R \, \diff Z,
\end{multline}
where $\vec{w}$ is a test function with the restriction $w_{\phi} = 0$. Note that the integral on the boundary is already omitted, as we impose a homogeneous \textsc{Neumann} boundary condition. As \textcite{Albert16} note: \enquote{If $\Omega$ is [extended] with a large enough current-free region around the actual domain of interest, this description is suited to approximately describe the decay of the magnetic field at infinite distance.}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../magdif"
%%% End: 
