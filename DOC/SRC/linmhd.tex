\section{Linearized MHD Force Balance}
\label{sec:linmhd}

In this chapter, we derive a solution of the linearized MHD force balance from \cref{eq:mhd-phi} in the field-aligned geometry described in \cref{sec:geom}. This corresponds to the application of the $\hat{P}$ operator in \cref{eq:P_operator} occurring in the iterations outlined in \cref{sec:iteration}. \Cref{sec:compute_presn} concerns the intermediate step of computing the pressure perturbation from the magnetic field perturbation, which is necessary for the computation of the current perturbation derived in \cref{sec:compute_currn}. Finally, in \cref{sec:sheets}, we discuss the extension of the ideal MHD model by the inclusion of sheet currents.

\subsection{Pressure Perturbation}
\label{sec:compute_presn}

Multiplying \cref{eq:mhd-phi} by $\vec{B}_{0}$ yields
\begin{align}
  c \vec{B}_{0} \cdot \grad p_{n} + \im n c p_{n} \vec{B}_{0} \cdot \grad \phi &= -\vec{B}_{n} \cdot (\vec{J}_{0} \times \vec{B}_{0}) = -c \vec{B}_{n} \cdot \grad p_{0} \nonumber \\
  \vec{B}_{0}^{\pol} \cdot \grad p_{n} + \im n p_{n} B_{0}^{\phi} &= -B_{n}^{\psi} p_{0}'(\psi). \label{eq:pn}
\end{align}
To solve this equation on one flux surface, we use a lowest-order finite difference method. Nodes are indexed by superscript $(k)$ and $\vec{r}^{(k)}$ is the position of node $(k)$, whereas $\vec{l}_{\fs}^{(k)} = \vec{r}^{(k+1)} - \vec{r}^{(k)}$ is the counter-clockwise vector between nodes on edge $\Gamma_{\fs}^{(k)}$. $\grad p_{n}$ is approximated at the midpoint of edge $\Gamma_{\fs}^{(k)}$ as finite difference of $p_{n}$ at nodes $(k)$ and $(k+1)$. $p_{n}$ is accordingly approximated at the midpoint as the arithmetic mean of the values at these nodes. With a shorthand $p_{n}^{(k)} = p_{n} (\vec{r}^{(k)})$ for the degrees of freedom we get
\begin{gather}
  \vec{B}_{0}^{\pol} (\Gamma_{\fs}^{(k)}) \cdot \frac{\vec{l}_{\fs}^{(k)}}{l_{\fs}^{(k)}} \frac{p_{n}^{(k+1)} - p_{n}^{(k)}}{l_{\fs}^{(k)}} + \im n B_{0}^{\phi} (\Gamma_{\fs}^{(k)}) \frac{p_{n}^{(k+1)} + p_{n}^{(k)}}{2} = -\td[p_{0}]{\psi} (\Gamma_{\fs}^{(k)}) B_{n}^{\psi} (\Gamma_{\fs}^{(k)}),
\end{gather}
where a unit vector along the edge is used to get the correct sign for the gradient in the direction of the poloidal magnetic field. Reordering in terms of the unknowns yields
\begin{gather}
  (b_{k} + a_{k}) p_{n}^{(k+1)} + (b_{k} - a_{k}) p_{n}^{(k)} = s_{k}
\end{gather}
with
\begin{align}
  a_{k} &= \vec{B}_{0}^{\pol} (\Gamma_{\fs}^{(k)}) \cdot \frac{\hat{\vec{l}}_{\fs}^{(k)}}{l_{\fs}^{(k)}}, \\
  b_{k} &= \frac{\im n B_{0}^{\phi} (\Gamma_{\fs}^{(k)})}{2}, \\
  s_{k} &= -\td[p_{0}]{\psi} (\Gamma_{\fs}^{(k)}) B_{n}^{\psi} (\Gamma_{\fs}^{(k)}).
\end{align}
In matrix form this scheme is written as
\begin{gather}
  K_{jk} p_{n}^{(k)} = s_{j},
\end{gather}
where the elements of the matrix $\hat{K}$ are
\begin{gather}
  K_{jk} = (b_{j} + a_{j}) \delta_{j-1, k} + (b_{j} - a_{j}) \delta_{jk}.
\end{gather}
Note that for $N$ nodes with periodic boundary conditions $p_{n}^{(0)} = p_{n}^{(N)}$, indices \enquote{wrap around}, resulting in the following shape for the stiffness matrix:
\begin{gather*}
  \hat{K} = \begin{pmatrix}
    b_{1} - a_{1} &  b_{1} + a_{1} &        0       & \hdots &    0   \\
           0       & b_{2} - a_{2} &  b_{2} + a_{2} & \hdots &    0   \\
           0       &        0       & b_{3} - a_{3} & \hdots &    0   \\
        \vdots     &     \vdots     &     \vdots     & \ddots & \vdots \\
     b_{N} + a_{N} &        0       &        0       & \hdots & b_{N} - a_{N}
  \end{pmatrix}.
\end{gather*}

\subsection{Current Perturbation}
\label{sec:compute_currn}

To derive an expression for the degrees of freedom of $\vec{J}_{n}$, we start from the linear force balance in \cref{eq:mhd-phi} and put the unknown current perturbation on one side:
\begin{gather}
  \underbrace{\vec{J}_{n} \times \vec{B}_{0}}_{\text{(I)}} = \underbrace{c (\grad p_{n} + \im n p_{n} \grad \phi)}_{\text{(II)}} - \underbrace{\vec{J}_{0} \times \vec{B}_{n}}_{\text{(III)}}. \label{eq:jnxB0}
\end{gather}
Taking a scalar product of some edge $\vec{l}$ -- in the course of this derivation, we don't indicate evaluation at the edge midpoint $\Gamma$ to avoid cluttering up the equations -- with term (I) in \cref{eq:jnxB0} yields
\begin{align}
  \vec{l} \cdot (\vec{J}_{n} \times \vec{B}_{0}) &= \vec{l} \cdot (\vec{J}_{n} \times (\grad \psi \times \grad \phi + B_{0 \phi} \grad \phi)) \\
  \intertext{with the definiton of the equilibrium field from \cref{eq:B_pol_tor}. Cyclic permutation gives}
  \vec{l} \cdot (\vec{J}_{n} \times \vec{B}_{0}) &= \vec{J}_{n} \cdot ((\grad \psi \times \grad \phi) \times \vec{l} + B_{0 \phi} \grad \phi \times \vec{l}), \\
  \intertext{where another triple product formula and the definition of the local coordinates from \cref{eq:edge_n} can be applied:}
  \vec{l} \cdot (\vec{J}_{n} \times \vec{B}_{0}) &= \vec{J}_{n} \cdot \left ( (\vec{l} \cdot \grad \psi) \grad \phi + \frac{B_{0 \phi}}{R} \vec{n} \right ). \\
  \intertext{Changing from co- to contravariant coordinates and carrying out the scalar product yields}
  \vec{l} \cdot (\vec{J}_{n} \times \vec{B}_{0}) &= (\vec{l} \cdot \grad \psi) J_{n}^{\phi} + R B_{0}^{\phi} \vec{J}_{n}^{\pol} \cdot \vec{n}.
\end{align}
On the right-hand side, we can insert the definition from \cref{eq:edge_l}, reorder and in the result replace the definition from \cref{eq:B_pol}, giving
\begin{gather}
  \vec{l} \cdot \grad \psi = \left( \vec{n} \times R \grad \phi \right) \cdot \grad \psi = -R \vec{B}_{0}^{\pol} \cdot \vec{n}. \label{eq:l_grad_psi}
\end{gather}
Finally,
\begin{gather}
  \vec{l} \cdot (\vec{J}_{n} \times \vec{B}_{0}) = R B_{0}^{\phi} \vec{J}_{n}^{\pol} \cdot \vec{n} - R J_{n}^{\phi} \vec{B}_{0}^{\pol} \cdot \vec{n}. \label{eq:jnxB0_I}
\end{gather}
Multiplying term (II) of \cref{eq:jnxB0} by $\vec{l}$ simply gives
\begin{gather}
  \vec{l} \cdot (\grad p_{n} + \im n p_{n} \grad \phi) = \vec{l} \cdot \grad p_{n}. \label{eq:jnxB0_II}
\end{gather}
We repeat the same procedure for term (III) of \cref{eq:jnxB0} and expand the cross product by poloidal-toroidal decomposition:
\begin{gather}
  \vec{l} \cdot (\vec{J}_{0} \times \vec{B}_{n}) = \vec{l} \cdot (B_{n \phi} \vec{J}_{0}^{\pol} \times \grad \phi + J_{0 \phi} \grad \phi \times \vec{B}_{n}^{\pol}).
\end{gather}
For the second term in parentheses, we again use cyclic permutation and the definition from \cref{eq:edge_n}:
\begin{align}
  \vec{l} \cdot (\grad \phi \times \vec{B}_{n}^{\pol}) &= \vec{B}_{n}^{\pol} \cdot (\vec{l} \times \grad \phi) \nonumber \\
  &= -\frac{1}{R} \vec{B}_{n}^{\pol} \cdot \vec{n}.
\end{align}
To simplify the first term in parentheses, we start from the equilibrium in \cref{eq:mhd-gen} and apply some of the previously used identities:
\begin{align}
  c \grad p_{0} &= \vec{J}_{0} \times \vec{B}_{0} \nonumber \\
  &= \vec{J}_{0}^{\pol} \times (B_{0 \phi} \grad \phi) + J_{0 \phi} \grad \phi \times (\grad \psi \times \grad \phi) \nonumber \\
  &= \vec{J}_{0}^{\pol} \times (B_{0 \phi} \grad \phi) + \frac{J_{0 \phi}}{R^{2}} \grad \psi \nonumber \\
  &= \vec{J}_{0}^{\pol} \times (B_{0 \phi} \grad \phi) + J_{0}^{\phi} \grad \psi.
\end{align}
Rearrangement yields
\begin{gather}
  \vec{J}_{0}^{\pol} \times \grad \phi = \frac{1}{B_{0 \phi}} \left( c \grad p_{0} - J_{0}^{\phi} \grad \psi \right).
\end{gather}
The intermediate result is
\begin{gather}
  \vec{l} \cdot (\vec{J}_{0} \times \vec{B}_{n}) = \frac{B_{n \phi}}{B_{0 \phi}} \left ( c \grad p_{0} - J_{0}^{\phi} \grad \psi \right ) \cdot \vec{l} - \frac{J_{0 \phi}}{R} \vec{B}_{n}^{\pol} \cdot \vec{n}.
\end{gather}
Reusing \cref{eq:l_grad_psi} and rearranging, we get
\begin{gather}
  \vec{l} \cdot (\vec{J}_{0} \times \vec{B}_{n}) = \frac{B_{n \phi}}{B_{0 \phi}} c \grad p_{0} \cdot \vec{l} + R J_{0}^{\phi} \left ( \frac{B_{n \phi}}{B_{0 \phi}} \vec{B}_{0}^{\pol} \cdot \vec{n} - \vec{B}_{n}^{\pol} \cdot \vec{n} \right ). \label{eq:jnxB0_III}
\end{gather}
Combining \cref{eq:jnxB0_I,eq:jnxB0_II,eq:jnxB0_III}, \cref{eq:jnxB0} is transformed to \cref{eq:jnphi-jnpol}:
\begin{gather}
  R B_{0}^{\phi} \vec{J}_{n}^{\pol} \cdot \vec{n} - R J_{n}^{\phi} \vec{B}_{0}^{\pol} \cdot \vec{n} = c \left ( \grad p_{n} - \frac{B_{n \phi}}{B_{0 \phi}} \grad p_{0} \right ) \cdot \vec{l} - R J_{0}^{\phi} \left ( \frac{B_{n \phi}}{B_{0 \phi}} \vec{B}_{0}^{\pol} \cdot \vec{n} - \vec{B}_{n}^{\pol} \cdot \vec{n} \right ). \label{eq:jnphi-jnpol}
\end{gather}
On edges \inw\ and \out\ where $\vec{B}_{0}^{\pol} \cdot \vec{n} \neq 0$, we can divide by this term and we obtain an expression for $J_{n}^{\phi}$ in terms of $\vec{J}_{n}^{\pol} \cdot \vec{n}$ and quantities which are known at this point:
\begin{gather}
  R J_{n}^{\phi} = J_{n (\phi)} = R B_{0}^{\phi} \frac{\vec{J}_{n}^{\pol} \cdot \vec{n}}{\vec{B}_{0}^{\pol} \cdot \vec{n}} + \frac{c}{\vec{B}_{0}^{\pol} \cdot \vec{n}} \left ( \frac{B_{n \phi}}{B_{0 \phi}} \grad p_{0} - \grad p_{n} \right ) \cdot \vec{l} + R J_{0}^{\phi} \left ( \frac{B_{n \phi}}{B_{0 \phi}} - \frac{\vec{B}_{n}^{\pol} \cdot \vec{n}}{\vec{B}_{0}^{\pol} \cdot \vec{n}} \right ). \label{eq:jnphi}
\end{gather}
On edge \fs, $\vec{B}_{0}^{\pol} \cdot \vec{n} = 0$ and $\grad p_{0} \cdot \vec{l} = 0$ (compare \cref{eq:l_grad_psi}), thus from \cref{eq:jnphi-jnpol}, no connection between $J_{n}^{\phi}$ and $\vec{J}_{n}^{\pol} \cdot \vec{n}$ can be made, but the latter expression can be given in terms of already known quantities:
\begin{gather}
  R \vec{J}_{n}^{\pol} \cdot \vec{n} = \frac{c \grad p_{n} \cdot \vec{l}}{B_{0}^{\phi}} + R \frac{J_{0}^{\phi}}{B_{0}^{\phi}} \vec{B}_{n}^{\pol} \cdot \vec{n}. \label{eq:If}
\end{gather}
With these relations established, we now consider the divergence of the perturbation current from \cref{eq:divfree-phi}. In cylindrical coordinates it reads, after multiplication by $R$,
\begin{gather}
  \pd{R} (R J_{n}^{k}) + \im n R J_{n}^{\phi} + \pd{Z} (R J_{n}^{k}) = 0.
\end{gather}
Using the divergence theorem this can also be written in integral form in a specific triangular mesh element $\Omega^{(k)}$ as
\begin{gather}
  \oint_{\partial \Omega^{(k)}} R \vec{J}_{n}^{\pol} \cdot \hat{\vec{n}} \, \diff l + \im n \int_{\Omega^{(k)}} R J_{n}^{\phi} \, \diff R \, \diff Z = 0.
\end{gather}
Here the first integral is performed over the 1-dimensional element boundary $\partial \Omega^{(k)} = \Gamma^{(k)}$. The first term is split into three contributions,
\begin{gather}
  \oint_{\partial \Omega^{(k)}} R \vec{J}_{n}^{\pol} \cdot \hat{\vec{n}} \, \diff l = \int_{\Gamma_{\inw}^{(k)}, \Gamma_{\out}^{(k)}} R \vec{J}_{n}^{\pol} \cdot \hat{\vec{n}} \, \diff l + \int_{\Gamma_{\fs}^{(k)}} R \vec{J}_{n}^{\pol} \cdot \hat{\vec{n}} \, \diff lx,
\end{gather}
where edge \fs\ is tangential to an adjacent flux surface and edges \inw\ and \out\ are not. Using the notation for currents established in \cref{eq:I_k}, we have
\begin{gather}
  I_{\inw} + I_{\out} + \im n \int_{\Omega} R J_{n}^{\phi} \diff S = -I_{\fs}.
\end{gather}
$I_{\fs}$ is already known from \cref{eq:If} and therefore acts as a source on the right-hand side. We take the remaining currents $I_{\inw}$ and $I_{\out}$ as unknowns. Since the current $I_{\out}$ flowing out of one triangle is equal to the current $-I_{\inw}$ flowing into the next triangle, these unknowns are connected on one strip of triangles, and we expect a system of equations similar to the one in \cref{sec:compute_presn}. The degrees of freedom and the unknowns are illustrated in \cref{fig:current_perturbation} with the unknowns marked in red, along with the indexing described further below.
\begin{figure}[bth]
  \centering
  \input{./current_perturbation.tikz}
  \caption{Schematic of the degrees of freedom and unknowns in the calculation of currents.}
  \label{fig:current_perturbation}
\end{figure}

Now, we deviate from \cref{eq:I_phi} and use a different approximation for the remaining integral:
\begin{gather}
  \im n I_{\phi} = \im n \int_{\Omega} R J_{n}^{\phi} \, \diff S \approx \im n S_{\Omega} \frac{R (\Gamma_{\inw}) J_{n}^{\phi} (\Gamma_{\inw}) + R (\Gamma_{\out}) J_{n}^{\phi} (\Gamma_{\out})}{2}.
\end{gather}
In this approximation, a term $R (\Gamma_{\fs}) J_{n}^{\phi} (\Gamma_{\fs})$ is neglected because within one strip of triangles, edge \fs\ alternates between the inner and outer flux surface and this \enquote{oscillation} of sample points would carry over to the approximation values, which is similar to the argument regarding the shifted centroid in \cref{sec:dofs}. Furthermore, $J_{n}^{\phi} (\Gamma_{\fs}) \cdot \vec{n}$ can't be reformulated in terms of $\vec{J}_{n}^{\pol} (\Gamma_{\fs})$ via \cref{eq:jnphi}, which would introduce the former as another unknown and lead to an overdetermined set of equations, possibly violating divergence-freeness. So instead, $I_{\phi}$ on each triangle is given by
\begin{gather}
  \im n I_{\phi} = \im n \int_{\Omega} R J_{n}^{\phi} \, \diff S \approx \frac{\im n S_{\Omega}}{2} \left ( \frac{B_{0}^{\phi} (\Gamma_{\inw})}{\vec{B}_{0}^{\pol} (\Gamma_{\inw}) \cdot \vec{n}_{\inw}} I_{\inw} + \frac{B_{0}^{\phi} (\Gamma_{\out})}{\vec{B}_{0}^{\pol} (\Gamma_{\out}) \cdot \vec{n}_{\out}} I_{\out} + \dotsb \right ),
\end{gather}
where we effectively reduced $I_{\phi}$ to $I_{\inw}$, $I_{\out}$ and already known terms by the relation between $\vec{J}_{n}^{\pol} \cdot \vec{n}$ and $J_{n}^{\phi}$ in \cref{eq:jnphi}. The remaining terms are moved to the right-hand-side as sources $s$, so the discretized equation in each triangle $\Omega$ is
\begin{gather}
  \left ( 1 + \frac{\im n S_{\Omega}}{2} \frac{B_{0}^{\phi} (\Gamma_{\inw})}{\vec{B}_{0}^{\pol} (\Gamma_{\inw}) \cdot \vec{n}_{\inw}} \right ) I_{\inw} + \left ( 1 + \frac{\im n S_{\Omega}}{2} \frac{B_{0}^{\phi} (\Gamma_{\out})}{\vec{B}_{0}^{\pol} (\Gamma_{\out}) \cdot \vec{n}_{\out}} \right ) I_{\out} = s. \label{eq:Ii-Io}
\end{gather}
The source term is given by
\begin{gather}
  s = -I_{\fs} - \frac{\im n S_{\Omega}}{2} \sum_{k = \inw, \out} \frac{c}{\vec{B}_{0}^{\pol} \cdot \vec{n}_{k}} \left ( \frac{B_{n \phi}}{B_{0 \phi}} \grad p_{0} - \grad p_{n} \right ) \cdot \vec{l}_{k} + R J_{0}^{\phi} \left ( \frac{B_{n \phi}}{B_{0 \phi}} - \frac{\vec{B}_{n}^{\pol} \cdot \vec{n}_{k}}{\vec{B}_{0}^{\pol} \cdot \vec{n}_{k}} \right ),
\end{gather}
where we again ommited evaluation at $\Gamma_{k}$ for the sake of brevity. Note that $\vec{B}_{n} (\Gamma_{k}) \cdot \vec{n}_{k}$ can be directly retrieved from $\Psi_{k}$, while $B_{n \phi} (\Gamma_{k})$ has to be calculated by averaging adjacent $B_{n \phi} (\Omega)$. The directional derivatives $\vec{l}_{k} \cdot \grad p_{n} (\Gamma_{k})$ are approximated by a difference quotient with values taken at the nodes (for indexing see \cref{fig:grid}),
\begin{align}
  \vec{l}_{\inw} \cdot \grad p_{n} (\Gamma_{\inw}) = l_{\inw} \hat{\vec{l}}_{\inw} \cdot \grad p_{n} (\Gamma_{\inw}) = l_{\inw} \pd[p_{n}]{\vec{l}_{\inw}} (\Gamma_{\inw}) & \approx l_{\inw} \frac{p_{n} (\vec{r}_{\vout}) - p_{n} (\vec{r}_{\vfs})}{\norm{\vec{r}_{\vout} - \vec{r}_{\vfs}}} = p_{n} (\vec{r}_{\vout}) - p_{n} (\vec{r}_{\vfs}), \\
  \vec{l}_{\out} \cdot \grad p_{n} (\Gamma_{\out}) = l_{\out} \hat{\vec{l}}_{\out} \cdot \grad p_{n} (\Gamma_{\out}) = l_{\out} \pd[p_{n}]{\vec{l}_{\out}} (\Gamma_{\out}) & \approx l_{\out} \frac{p_{n} (\vec{r}_{\vfs}) - p_{n} (\vec{r}_{\vinw})}{\norm{\vec{r}_{\vfs} - \vec{r}_{\vinw}}} = p_{n} (\vec{r}_{\vfs}) - p_{n} (\vec{r}_{\vinw}),
\end{align}
where the sign has to be reversed for the type of triangle with node \vfs\ on the outer flux surface. This is actually a shortcoming of the convention that nodes are named according to their opposite edges; in the implementation, we use a subroutine that gives the nodes of edges in consistent counter-clockwise order, so this case distinction is not necessary at this level. The same logic applies to $\vec{l} \cdot \grad p_{0}$ terms.

For the global\footnote{in this case only referring to the current triangle strip, as opposed to the local indexing of individual triangles} indexing scheme, we call the ingoing current into triangle $(k)$ counted in counter-clockwise direction $I^{(k)}$. In triangle $(k)$, this is equal to $I_{\inw} = -I^{(k)}$ and $I_{\out} = I^{(k+1)}$. This is also illustrated in \cref{fig:current_perturbation}, where triangles are counted from one starting at the right end of the sketch. The matrix form of \cref{eq:Ii-Io} is then
\begin{gather}
  K_{jk} I^{(k)} = s_{j},
\end{gather}
where the elements of the stiffness matrix $\hat{K}$ are
\begin{gather}
  K_{jk} = -\left ( 1 + \frac{\im n S_{\Omega^{(j)}}}{2} \frac{B_{0}^{\phi} (\Gamma_{\inw}^{(j)})}{\vec{B}_{0}^{\pol} (\Gamma_{\inw}^{(j)}) \cdot \vec{n}_{\inw}^{(j)}} \right) \delta_{jk} + \left( 1 + \frac{\im n S_{\Omega^{(j)}}}{2} \frac{B_{0}^{\phi} (\Gamma_{\out}^{(j)})}{\vec{B}_{0}^{\pol} (\Gamma_{\out}^{(j)}) \cdot \vec{n}_{\out}^{(j)}} \right) \delta_{j+1, k}.
\end{gather}

\subsection{Current Sheets}
\label{sec:sheets}

We have not considered one aspect of resonances yet. Starting from the static MHD equilibrium in \cref{eq:mhd-gen}, we see that only the normal component of the current density is relevant, i.e.
\begin{gather}
  \grad p = \frac{1}{c} \vec{J}^{\perp} \times \vec{B},
\end{gather}
while the parallel component $\vec{J}^{\parallel} = J^{\parallel} \vec{h}$ is not fixed. Nevertheless, $\vec{J}$ must have zero divergence:
\begin{gather}
  -\divg \vec{J}^{\perp} = \divg \frac{J^{\parallel} \vec{B}}{B} = \vec{B} \cdot \grad \frac{J^{\parallel}}{B}.
\end{gather}
Expanding in flux symmetry coordinates gives
\begin{gather}
  -\divg \vec{J}^{\perp} = \left ( B^{\theta} \pd{\theta} + B^{\phi} \pd{\phi} \right ) \frac{J^{\parallel}}{B} = B^{\theta} \left ( \pd{\theta} + q \pd{\phi} \right ) \frac{J^{\parallel}}{B},
\end{gather}
which is rearranged to
\begin{gather}
  -\frac{\divg \vec{J}^{\perp}}{B^{\theta}} = \left ( \pd{\theta} + q \pd{\phi} \right ) \frac{J^{\parallel}}{B}
\end{gather}
and \textsc{Fourier} transformed to
\begin{gather}
  s_{m n} = \im (m + n q) \left [ \frac{J^{\parallel}}{B} \right ]_{m n},
\end{gather}
where the left-hand side has been grouped together in the \textsc{Fourier} coefficient \ensuremath{s_{m n}}. Rearranging yields
\begin{gather}
  \frac{s_{m n}}{\im (m + n q)} = \left [ \frac{J^{\parallel}}{B} \right ]_{m n}. \label{eq:jpar_mn}
\end{gather}
For comparison, translation to the conventions of this thesis of eq.~(1) in the paper by \textcite{Waelbroeck09} gives
\begin{gather}
  \left [ \frac{J^{\parallel}}{B} \right ]_{m n} = \frac{4 \pi p'(\rho)}{\langle B^{2} \rangle} \sum_{m, n} \frac{\symcal{G}_{m n} (\rho)}{q(\rho) - \frac{m}{n}} + C_{m n} \delta \left ( q(\rho) - \frac{m}{n} \right ), \label{eq:resonances}
\end{gather}
where the $\symcal{G}_{m n}$ are geometric factors and the $C_{m n}$ are integration constants. The additional delta distribution term in \cref{eq:resonances} is apparently missing from \cref{eq:jpar_mn} and we [\ldots] to add it in order to better capture the physical behaviour of the sheet currents. To approximate the delta distribution, we consider the distortion $\delta \psi$ of flux surfaces, specifically \cref{eq:psi_mn}. A similar expression can be derived by expanding \cref{eq:pn} in flux symmetry coordinates, giving
\begin{gather}
  B_{0}^{\theta} \pd{\theta} p_{n} + \im n p_{n} B_{0}^{\phi} = -B_{n}^{\psi} p_{0}'(\psi),
\end{gather}
which is again rearranged to
\begin{gather}
  \pd{\theta} p_{n} + \im n q p_{n} = -p_{0}'(\psi) \frac{B_{n}^{\psi}}{B_{0}^{\theta}}
\end{gather}
and \textsc{Fourier} transformed to
\begin{gather}
  \im m p_{m n} + \im n q p_{m n} = -p_{0}'(\psi) \left [ \frac{B_{n}^{\psi}}{B_{0}^{\theta}} \right ]_{m},
\end{gather}
which is finally rearranged to
\begin{gather}
  p_{m n} = \frac{-p_{0}'(\psi)}{\im (m + n q)} \left [ \frac{B_{n}^{\psi}}{B_{0}^{\theta}} \right ]_{m}.
\end{gather}
When a resonance occurs at poloidal mode number $m_{0}$, around the affected flux surface the pressure perturbation is dominated by the associated \textsc{Fourier} coefficient,
\begin{gather}
  p_{m_{0} n} \gg p_{m n} \quad \forall m \neq m_{0}
\end{gather}
and thus
\begin{gather}
  p_{n} \approx \e^{\im m_{0} \theta} p_{m_{0} n}.
\end{gather}
Putting everything together, we approximate the sheet current by
\begin{gather}
  \left [ \frac{J^{\parallel}}{B} \right ]_{m n} = C_{m n} p_{m n} \delta_{m m_{0}},
\end{gather}
or, after an inverse \textsc{Fourier} transform,
\begin{gather}
  J_{n}^{\parallel} = C_{m_{0} n} B_{0} p_{n}. \label{eq:sheet-currents}
\end{gather}
For a given set of $C_{m n}$ values, we project $J_{n}^{\parallel}$ onto currents $I_{\inw}$ and $I_{\out}$, which we add to the values computed in \cref{sec:compute_currn} in between the flux surfaces where $q$ is closest to the respective $m/n$ resonance. $I_{\fs}$ has no contribution from this parallel current, so $I_{\phi}$ is modified to uphold divergence-freeness.\enlargethispage{\baselineskip}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../magdif"
%%% End: 
