\section{Preprocessing of Input Data}
\label{sec:inputs}

Prior to starting iterations, some input data has to supplied, namely the following:
\begin{itemize}
\item coordinates of grid points, numbering of grid points and triangles including edge adjacency list -- described in \cref{sec:grid-impl};
\item the equilibrium magnetic field $\vec{B}_{0}$ from which the grid is generated;
\item the vacuum perturbation field $\Bvac$ and
\item optionally the equilibrium pressure $p_{0}$.
\end{itemize}
Additonally, a configuration file exists to specify behaviour of the implemented algorithms and data input/output.

The equilibrium field $\vec{B}_{0}$ is assumed to be available in GEQDSK format, shortly summarized by \textcite{Lao97}. It consists of data points given on a rectangular grid which are fitted from measurements to the \textsc{Grad}--\textsc{Shafranov} equation. Parts of already existing code import such a file and generate a field-aligned grid as described in \cref{sec:grid} and specified in \cref{sec:grid-impl}. It also supplies values of $\vec{B}_{0}$ and its partial derivatives on arbitrary $R, Z$ coordinates by interpolation with splines of fifth order in $R$ and $Z$ based on \cref{eq:B0R,eq:B0Z}. In the implementation of NEO-EQ, the necessary values on edge midpoints and shifted centroids are cached once before calculations starts as to avoid repeated function calls to spline interpolation and possibly allow for other data sources. From $\vec{B}_{0}$, the safety factor $q$ is computed as described in \cref{sec:safety_factor}.

While the equilibrium pressure $p_{0}$ should be available from the GEQDSK file and and the equilibrium current $\vec{J}_{0}$ can be computed from the equilibrium field via Ampère's law as in \cref{eq:ampere-gen}, another approach is possible. Since Ampère's law is never used for equilibrium quantities, it is possible to choose a pressure profile and calculate $J_0^{\phi}$ to be consistent with the MHD equilibrium in \cref{eq:mhd-gen}. The latter is the \textsc{Pfirsch}--\textsc{Schlüter} current and its calculation is outlined in \cref{sec:j0phi}. The simplest approach to the pressure profile assumes a linear profile for the particle density $n$ and temperature $T$,
\begin{align}
  n^{(k)} &= n_{\text{LCFS}} + \frac{\psi^{(k)} - \psi_{\text{LCFS}}}{\psi_{\text{axis}} - \psi_{\text{LCFS}}} n_{\text{step}}, \label{eq:dens} \\
  T^{(k)} &= T_{\text{LCFS}} + \frac{\psi^{(k)} - \psi_{\text{LCFS}}}{\psi_{\text{axis}} - \psi_{\text{LCFS}}} T_{\text{step}}, \label{eq:temp}
\end{align}
where $k$ refers to the index of the flux surface. The subscripts LCFS and axis indicate the value at the separatrix and the magnetic axis, respectively. The configurable values are then the step sizes $n_{\text{step}}$ and $T_{\text{step}}$ as well as $n_{\text{LCFS}}$ and $T_{\text{LCFS}}$. From these, the pressure is calculated by the ideal gas law:
\begin{gather}
  p_{0} = n k_{\text{B}} T.
\end{gather}
Additionally, with the formulae given above, one can also derive an expression for the equilibrium pressure gradient:
\begin{gather}
  p_{0}' (\psi) = n' (\psi) k_{\text{B}} T + n k_{\text{B}} T' (\psi) = \frac{n_{\text{step}} k_{\text{B}} T + n k_{\text{B}} T_{\text{step}}}{\psi_{\text{axis}} - \psi_{\text{LCFS}}}.
\end{gather}
Thus all necessary equilibrium quantities are established.

The vacuum perturbation field $\Bvac$ is calculated beforehand from the external coil currents $I_{\text{c}}$ by the \textsc{Biot}--\textsc{Savart} law (\cref{eq:biot-savart}) on a regular grid in $(R, \phi, Z)$ coordinates, from which the fluxes through triangle edges are computed for representation as \textsc{Raviart}--\textsc{Thomas} elements.

\subsection{Grid Implementation}
\label{sec:grid-impl}

Since the grid is field-aligned, there are a few conventions to be considered compared to more arbitrary grids. The code has to \enquote{find its way}, so we make assumptions on numbering.

The number of flux surfaces realized on the grid is known and referred to as \nflux. The numbers increase going outward from the magnetic axis which is \emph{not} included and thus gets the index 0. Flux variables like $\psi$, $p_{0}$ and $p_{0}' (\psi)$ are calculated at these flux surfaces and use the same indexing scheme. Others, like $q$ are calculated \emph{between} flux surfaces and are called half-grid quantities. In this case, the index refers to the outer or enclosing flux surface and starts at 1. When half-grid quantities are needed at full-grid positions or vice versa, they are linearly interpolated between neighbouring values, with one exception: if an interpolation point lies outside the separatrix, an appropriate interpolation point on the separatrix is used instead.

Node numbering starts from 1 at the magnetic axis, increasing towards the separatrix. Then, the nodes on the enclosing flux surface (index 1) are enumerated counter-clockwise, starting with the node lying on the line connecting the magnetic axis and the X point. Then the next enclosing flux surface (index 2) is enumerated and so on. This way a simple bijection between \enquote{global} node numbering and the \enquote{local} numbering on a specific flux surface can be implemented. The flux surface indexing is the same as for full-grid quantities and the number of nodes per flux surface needs to be known. \Cref{fig:numbering_nodes} illustrates global node numbering.

Triangle numbering operates on similar assumptions, albeit with flux surface indexing akin to half-grid quantities. The innermost triangle strip (index 1) is enumerated first, starting at index 1 for the triangle formed by nodes 1, 2 and 3. It also goes counterclockwise and on each flux surface starts with the triangle whose edge \inw\ lies on the line between the magnetic axis and the X point, i.e. it follows node numbering. Again, local numbering on a triangle strip can be converted to global numbering when the number of triangles is known. \Cref{fig:numbering_triangles} illustrates global triangle numbering.

\savebox{\imagebox}{\input{./numbering_nodes.tikz}}%
\begin{figure}[bth]
  \centering
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \usebox{\imagebox}
    \caption{Global numbering scheme for nodes. Local indices refer to the flux surfaces on which the nodes reside. The mapping from local to global numbering would then produce, for example, $(0, 1) \to 1$, $(1, 1) \to 2$, $(1, 24) \to 25$, $(2, 1) \to 26$, $(2, 24) \to 49$, $(3, 1) \to 50$ and so on.}
    \label{fig:numbering_nodes}
  \end{subfigure}
  \quad
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \raisebox{\dimexpr\ht\imagebox-\height}{\input{./numbering_triangles.tikz}}
    \caption{Global numbering scheme for triangles. Local indices refer to the \emph{enclosing} flux surface of the triangle. The mapping from local to global numbering would then produce, for example, $(1, 1) \to 1$, $(1, 24) \to 24$, $(2, 1) \to 25$, $(2, 48) \to 72$, $(3, 1) \to 73$ and so on.}
    \label{fig:numbering_triangles}
  \end{subfigure}
  \caption{Juxtaposition of numbering schemes for nodes and triangles. In both drawings, the flux surfaces are indicated by $\psi^{(k)}$ with $k$ being the index of the flux surface. There are 24 nodes on each flux surface and the horizontal line connects to the X point, which means numbering on each flux surface starts there.}
  \label{fig:numbering_scheme}
\end{figure}

Associated with each triangle are local indices, i.e. 1 to 3, for nodes and edges. The global node number is saved for each local node number. The edges don't have a global index and are numbered so that edge 1 connects node 1 to 2, edge 2 connects node 2 to 3 and edge 3 connects node 3 to 1. When the index of node \vfs\ is known and the aforementioned conventions are followed, the symbolic designations \fs, \inw, \out\ can be mapped to the local edge index, \vfs, \vinw, \vout\ to the local (and global) node index and edge vectors $\vec{l}$ can be given in counter-clockwise direction. Furthermore, an adjacency list is constructed, giving any triangle's neighbour on a given edge and the local edge number in the neighbouring triangle.

Scalar quantities like $p_{n}$ are indexed by global node number and vector quantities like $\vec{B}_{n}$ and $\vec{J}_{n}$ are indexed by global triangle number and local edge number. The latter convention involves some redundancy as it takes twice the storage that would be necessary, but it also allows for consistency checks and a simpler implementation.

\subsection{Toroidal Unperturbed Current}
\label{sec:j0phi}

Since $\vec{B}_{0}$ and $p_{0}$ are directly available as input data, but $\vec{J}_{0}$ is not, the latter will be derived below from \cref{eq:mhd-gen}, the condition of divergence-freeness and symmetry considerations.

We take a cross-product of \cref{eq:mhd-gen} by $\vec{B}_{0}$:
\begin{align}
  \vec{B}_{0} \times \left( \vec{J}_{0} \times \vec{B}_{0} \right) &= B_{0}^{2} \vec{J}_{0} - (\vec{B}_{0} \cdot \vec{J}_{0}) \vec{B}_{0} \nonumber \\
  &= B_{0}^{2} (\vec{J}_{0} - J_{0}^{\parallel} \vec{h}_{0}) \nonumber \\
  &= B_{0}^{2} \vec{J}_{0}^{\perp}.
\end{align}
Therefore
\begin{gather}
  \vec{J}_{0}^{\perp} = \frac{-c \grad p_{0} \times \vec{B}_{0}}{B_{0}^{2}},
\end{gather}
which is the diamagnetic current density. For the parallel current density we use
\begin{align}
 0 = \divg \vec{J}_{0} &= \divg \vec{J}_{0}^{\perp} + \divg (J_{0}^{\parallel} \vec{h}_{0}) \nonumber \\
 &= -c \divg \frac{\grad p_{0} \times \vec{B}_{0}}{B_{0}^{2}} + \vec{B}_{0} \cdot \grad \frac{J_{0}^{\parallel}}{B_{0}}.
\end{align}
In symmetry flux coordinates $(\rho, \phi, \theta)$ and Jacobian $\sqrt{g}$ outlined in \cref{sec:cocos}, the divergence of the diamagnetic current is
\begin{align}
  \divg \vec{J}_{0}^{\perp} &= -\frac{c}{\sqrt{g}} \pd{u^{k}} \left[ \frac{\sqrt{g}}{B_{0}^{2}} \left( \grad p_{0} \times \vec{B}_{0} \right)^{k} \right] \nonumber \\
  &= -\frac{c}{\sqrt{g}} \pd{u^{k}} \left( \frac{\sqrt{g}}{B_{0}^{2}} \frac{\varepsilon^{ijk}}{\sqrt{g}} \pd[p_{0}]{u^{i}} B_{0 j} \right) \nonumber \\
  &= -\frac{c p_{0}' (\rho) B_{0 \phi}}{\sqrt{g}} \pd{\theta} \frac{1}{B_{0}^{2}},
\end{align}
since $p_{0}$ and $B_{0 \phi}$ are constant on a flux surface, $\pd[p_{0}]{\theta} = 0$ and due to axisymmetry $\pd{\phi} = 0$ for equilibrium quantities. The divergence of the parallel current is
\begin{gather}
  \divg(J_{0}^{\parallel} \vec{h}_{0}) = \vec{B}_{0} \cdot \grad \frac{J_{0}^{\parallel}}{B_{0}} = B_{0}^{\theta} \pd{\theta} \frac{J_{0}^{\parallel}}{B_{0}}.
\end{gather}
With $\sqrt{g} B_{0}^{\theta} = \psi'(\rho) = -1$ as a flux surface quantity, there are no dependencies of $\theta$ in front of the derivatives:
\begin{gather}
  -c p_{0}' (\rho) B_{0 \phi} \pd{\theta} \frac{1}{B_{0}^{2}} + \psi'(\rho) \pd{\theta} \frac{J_{0}^{\parallel}}{B_{0}} = 0.
\end{gather}
Direct integration and a change of variables and notation as in
\begin{gather}
  \frac{p_{0}'(\rho)}{\psi'(\rho)} = \frac{\pd[p_{0}]{\rho}}{\pd[\psi]{\rho}} = \pd[p_{0}]{\psi} = p_{0}'(\psi)
\end{gather}
yields
\begin{gather}
  \frac{-c p_{0}' (\psi) B_{0 \phi}}{B_{0}^{2}} + \frac{J_{0}^{\parallel}}{B_{0}} = C(\psi). \label{eq:j0parallel_general}
\end{gather}
With the extra condition of the flux-surface average\footnote{See \cref{eq:flux_surface_avg}, but note that it is not actually evaluated here.} $\left\langle J_{0}^{\parallel} B_{0} \right\rangle = 0$ for testing without bootstrap current, we obtain
\begin{gather}
  -c p_{0}'(\psi) B_{0 \phi} = C(\psi) \left\langle B_{0}^{2} \right\rangle.
\end{gather}
In general, 
\begin{gather}
  C(\psi) = -\frac{c p_{0}'(\psi) B_{0 \phi}}{\left\langle B_{0}^{2} \right\rangle} D(\psi),
\end{gather}
with $D(\psi)$ set to 1 for now and modified for the more general case $\left\langle J_{0}^{\parallel} B_{0} \right\rangle \not\equiv 0$. Inserting this back into \cref{eq:j0parallel_general} yields
\begin{gather}
  J_{0}^{\parallel} = \frac{c p_{0}'(\psi) B_{0 \phi}}{B_{0}} \left( 1 - \frac{B_{0}^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) \right).
\end{gather}

For the unperturbed toroidal current density we have
\begin{gather}
  J_{0}^{\phi} = J_{0}^{\parallel} h_{0}^{\phi} + \vec{J}_{0}^{\perp} \cdot \grad \phi,
\end{gather}
where
\begin{align}
  J_{0}^{\parallel} h_{0}^{\phi} &= \frac{c p_{0}'(\psi) B_{0 \phi}}{B_{0}} \frac{B_{0}^{\phi}}{B_{0}} \left( 1 - \frac{B_{0}^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) \right) \nonumber \\
  &= c p_{0}'(\psi) \frac{\left( B_{0}^{\tor} \right)^{2}}{B_0^2} \left( 1 - \frac{B_{0}^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi) \right) \nonumber \\
  &= c p_{0}'(\psi) \left( B_{0}^{\tor} \right)^{2} \left( \frac{1}{B_{0}^{2}} - \frac{D(\psi)}{\left\langle B_{0}^{2} \right\rangle} \right).
\end{align}
and
\begin{align}
  \vec{J}_{0}^{\perp} \cdot \grad \phi &= \frac{-c p_{0}'(\psi) \grad \phi \cdot (\grad \psi \times \vec{B}_{0})}{B_{0}^{2}} \nonumber \\
  &= \frac{-c p_{0}'(\psi) \vec{B}_{0} \cdot (\grad \phi \times \grad \psi)}{B_{0}^{2}} \\
  &= \frac{c p_{0}'(\psi)}{B_{0}^{2}} \vec{B}_{0}^{\pol} \cdot \vec{B}_{0} \nonumber \\
  &= c p_{0}'(\psi) \frac{\left( B_{0}^{\pol} \right)^{2}}{B_{0}^{2}}.
\end{align}
It follows that
\begin{gather}
  J_{0}^{\phi} = c p_{0}'(\psi) \left( \frac{\left( B_{0}^{\pol} \right)^{2} + \left( B_{0}^{\tor} \right)^{2}}{B_{0}^{2}} - \frac{\left( B_{0}^{\tor} \right)^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi)\right) = c p_{0}'(\psi) \left( 1 - \frac{\left( B_{0}^{\tor} \right)^{2}}{\left\langle B_{0}^{2} \right\rangle} D(\psi)\right).
\end{gather}

\subsection{Safety Factor}
\label{sec:safety_factor}

Computing the safety factor from \cref{eq:q_field_line_pitch} would require the calculation of $\theta$ coordinate lines from $\vec{B}_{0}$. An equivalent definition from \textcite{dHaeseleer91} involves the toroidal flux $\psi_{\tor}$, which in our choice of coordinates is given by
\begin{gather}
  \psi_{\tor} = \frac{1}{(2 \pi)^{2}} \int \diff V \, \vec{B}_{0} \cdot \grad \phi = \frac{1}{2 \pi} \int \diff R \, \diff Z \, R B_{0}^{\phi} = \frac{1}{2 \pi} \int \diff R \, \diff Z \, B_{0 (\phi)}.
\end{gather}
Note that $\psi_{\tor} < 0$ and $\psi_{\tor}' (\rho) < 0$. The safety factor is then given by
\begin{gather}
  q = \frac{\psi_{\tor}' (\rho)}{\psi_{\pol}' (\rho)} = \frac{-\psi_{\tor}' (\psi)}{-\psi_{\pol}' (\psi)} = \td[\psi_{\tor}]{\psi} = \frac{1}{2 \pi} \td{\psi} \int \diff R \, \diff Z \, B_{0 (\phi)}.
\end{gather}
This flux quantity can be evaluated numerically at half-grid steps by adding up $B_{0 (\phi)}$ inside the volume between two flux surfaces and dividing by the the difference in $\psi$:
\begin{gather}
  q \approx \frac{1}{2 \pi \symup{\Delta} \psi} \sum_{k} B_{0 (\phi)} (\Omega^{(k)}) S_{\Omega^{(k)}},
\end{gather}
where the sum is taken over all triangles $\Omega$ inside a triangle strip, and $S_{\Omega}$ is the respective triangle surface area. Note that both $B_{0 (\phi)}$ and $\symup{\Delta} \psi$ are negative, so $q$ is positive overall.

[figure: approximation from test runs]

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../magdif"
%%% End: 
